<!DOCTYPE html>
<html lang="de">
<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <!-- Material Icons & Font Awesome for modern icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <meta charset="UTF-8">
  <title>Sponser Bestellshop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <link rel="icon" type="image/png" href="/assets/icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icon.png">
  <link rel="manifest" href="/manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    html, body { margin:0; padding:0; background:#fff; color:#222; font-family: Arial, sans-serif; min-height:100vh; width:100vw; overflow-x:hidden;}
    /* Zentrierte Sprachumschaltung */
    .lang-switch-center {
      display: flex;
      gap: 12px;
      justify-content: center;
      align-items: center;
      margin: 0 auto 0 auto;
      position: relative;
      z-index: 10;
      padding-top: 0;
    }
    .lang-text-btn {
      background: #f7f7f7;
      border: none;
      color: #555;
      font-size: 1.09em;
      font-weight: 500;
      letter-spacing: 0.04em;
      border-radius: 18px;
      padding: 7px 22px;
      cursor: pointer;
      opacity: 0.84;
      transition: color 0.13s, background 0.15s, opacity 0.13s;
      outline: none;
      box-shadow: none;
      margin: 0 2px;
    }
    .lang-text-btn.selected,
    .lang-text-btn:focus {
      color: #e10c18;
      background: #fff0f4;
      opacity: 1;
      box-shadow: 0 2px 8px rgba(225,12,24,0.08);
    }
    .main-logo-center {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0 auto 0 auto;
      z-index: 9;
    }
    .main-logo-colored {
      width: 220px;
      max-width: 80vw;
      height: auto;
      display: block;
      margin: 0 auto;
      filter: none;
      box-shadow: none;
      border-radius: 0;
      background: none;
    }
  /* Hintergrundlogo entfernt */
    .order-title {
      display: none;
    }
    .main-cart { font-size: 2.1em; margin: 0; cursor: pointer; color: #e10c18; display: flex; align-items: center; justify-content: center; position: relative;}
    .main-cart img { height: 45px; width: 45px; filter: grayscale(20%);}
    .cart-count { background:#e10c18; color:#fff; font-size:1em; border-radius:50%; padding:2px 8px; position:absolute; top:3px; left:31px; font-weight:bold; z-index:2;}
    .main {
  width: 100vw;
  max-width: 100vw;
  margin: 0;
  padding: 0;
  box-sizing: border-box;
    }
    .product-grid {
  display: flex;
  flex-direction: column;
  gap: 24px;
  width: 100%;
  max-width: 100%;
  padding: 0;
    }
    .product-card {
  background:#fff;
  border-radius: 18px;
  box-shadow: 0 4px 18px rgba(0,0,0,0.08);
  width: 100%;
  margin: 0;
  padding: 1.15em 0 1.25em 0;
  border: none;
  display: flex;
  flex-direction: column;
  align-items: center;
  transition:.13s;
  cursor:pointer;
    }
    .product-card:hover { background: #fafafc; }
    .product-img { width:88px; height:88px; border-radius:9px; object-fit:contain; margin-bottom:0.6em;}
    .product-title { font-weight:bold; font-size:1.17em; text-align:center; }
    .product-price { color:#e10c18; font-size:1.18em; font-weight:bold; margin-top:7px;}
    .product-desc { color:#444; font-size:1.05em; text-align:center; margin-top:0.5em; min-height:36px;}
    .detail-page {
  width: 100vw;
  max-width: 100vw;
  margin: 0;
  padding: 1.2em 12px 1.2em 12px;
  border-radius: 0;
  background: #fff;
    }
    .detail-img { width:160px; height:160px; object-fit:contain; background:#f7f7f7; border-radius:16px; display:block; margin:0 auto 1em auto;}
    .detail-title { font-size: 1.18em; font-weight:bold; margin-bottom:0.18em;}
    .desc-block {margin:0.48em 0 1.18em 0; color:#444; font-size:1em;}
    .detail-variant {margin:0.55em 0;}
    .variant-btn { padding:11px 18px; border:1.5px solid #ccc; border-radius:14px; margin-right:6px; background:#f7f7f7; font-size:1.09em; cursor:pointer; margin-bottom:7px;}
    .variant-btn.selected { border:2px solid #e10c18; background:#fff0f2; color:#e10c18; font-weight:bold;}
    .price-block {font-size:1.12em;font-weight:bold;margin:0.35em 0 0.6em 0;color:#e10c18;}
    .qty-select {font-size:1.09em;width:56px;padding:7px 7px;border-radius:10px;border:1.4px solid #bbb;text-align:center;}
  .addcart-btn { background:#e10c18;color:#fff;font-weight:bold;font-size:1.12em;padding:1.03em 0;border-radius:12px;border:none;margin:0.8em 0 0 0;cursor:pointer;width:100%;max-width:unset;display:block;margin-left:auto;margin-right:auto;}
    .addcart-btn:active {background:#bb0920;}
    .back-btn { background:#eee;border:none;color:#333;padding:0.5em 1.5em;border-radius:10px;cursor:pointer;margin-bottom:1.1em;}
    .cart-page {
      width:100vw;
      max-width:100vw;
      margin:0 auto;
      padding: 0 12px;
    }
    .cart-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 2px 13px rgba(0,0,0,0.07);
      margin-bottom: 18px;
      padding: 1.1em 1em 1.1em 1em;
      border: none;
      transition: box-shadow 0.13s;
      position: relative;
    }
    .cart-item:last-child { margin-bottom: 0; }
    .cart-img {
      width: 56px;
      height: 56px;
      object-fit: contain;
      background: #f7f7f7;
      border-radius: 9px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.03);
    }
    .cart-info {
      flex: 1;
      margin-left: 13px;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .cart-prod {
      font-weight: bold;
      font-size: 1.13em;
      color: #1a1a1a;
      margin-bottom: 1px;
      line-height: 1.15;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .cart-variant {
      font-size: 0.99em;
      color: #666;
      font-style: italic;
      margin-bottom: 1px;
      line-height: 1.1;
    }
    .cart-price {
      color: #e10c18;
      font-weight: bold;
      font-size: 1.13em;
      margin-left: 11px;
      min-width: 82px;
      text-align: right;
    }
    .cart-qty {
      width: 44px;
      text-align: center;
      font-size: 1em;
      margin: 0 8px;
      border-radius: 8px;
      border: 1.2px solid #bbb;
      padding: 4px;
      background: #fafbfc;
      color: #222;
    }
    .cart-remove {
      color: #c1c1c1;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.6em;
      margin-left: 10px;
      transition: color 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .cart-remove:hover {
      color: #e10c18;
      background: #fff0f2;
      border-radius: 50%;
    }
    .cart-total {
      font-size: 1.19em;
      font-weight: bold;
      text-align: right;
      margin: 1.08em 0 1.08em 0;
      color: #e10c18;
    }
    .order-btn {
      background: linear-gradient(90deg, #e10c18 70%, #ff3c4e 100%);
      color: #fff;
      font-weight: bold;
      font-size: 1.15em;
      padding: 1.04em 0;
      border-radius: 13px;
      border: none;
      width: 100%;
      margin-top: 1.18em;
      box-shadow: 0 2px 8px rgba(225,12,24,0.07);
      transition: background 0.13s, box-shadow 0.13s;
    }
    .order-btn:active {
      background: #bb0920;
    }
    .emptycart {
      color: #aaa;
      text-align: center;
      margin: 2.5em 0;
      font-size: 1.18em;
      letter-spacing: 0.01em;
    }
    @media (min-width:701px){
      .main, .product-grid, .product-card, .detail-page, .cart-page { max-width:520px; width:100%; margin:0 auto;}
    }
  /* Neue Top-Navigation */
  .top-nav {
    position: fixed;
    left: 0;
    right: 0;
    top: 0;
    bottom: auto;
    height: 62px;
    background: #fff;
    border-bottom: 1.5px solid #ececec;
    border-top: none;
    display: flex;
    justify-content: space-around;
    align-items: center;
    z-index: 101;
    box-shadow: 0 4px 18px rgba(0,0,0,0.08);
    padding-top: 0;
    border-radius: 0 0 18px 18px;
  }
  .nav-btn {
    flex: 1 1 0;
    text-align: center;
    font-size: 1.05em;
    color: #e10c18;
    background: none;
    border: none;
    outline: none;
    text-decoration: none;
    font-weight: 600;
    letter-spacing: 0.01em;
    padding: 0;
    transition: background 0.15s, color 0.13s;
    border-radius: 7px 7px 0 0;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 0;
  }
  .nav-btn .fa-solid, .nav-btn .material-icons {
  font-size: 2.1em;
  display: block;
  margin-bottom: 0px;
  margin-top: 0px;
  line-height: 1;
  }
  .nav-btn span.label {
    font-size: 1em;
    margin-top: 2px;
    color: inherit;
    font-weight: 500;
    letter-spacing: 0.01em;
    line-height: 1.1;
  }
  .nav-btn {
    flex: 1 1 0;
    text-align: center;
    font-size: 1.01em;
    color: #e10c18;
    background: none;
    border: none;
    outline: none;
    text-decoration: none;
    font-weight: 600;
    letter-spacing: 0.01em;
    padding: 7px 0 0 0;
    transition: background 0.15s, color 0.13s;
    border-radius: 7px 7px 0 0;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 0;
  }
  .nav-btn:active,
  .nav-btn:hover {
    background: #f4f4f8;
    color: #bb0920;
    text-decoration: none;
  }
  .nav-btn .material-icons,
  .nav-btn .fa-solid {
    font-size: 1.7em;
    display: block;
    margin-bottom: -2px;
    line-height: 1;
  }
  .nav-btn span.label {
    font-size: 0.97em;
    margin-top: 1px;
    color: inherit;
    font-weight: 500;
    letter-spacing: 0.01em;
  }
  .cart-count {
    background: #e10c18;
    color: #fff;
    font-size: 0.95em;
    border-radius: 50%;
    padding: 2px 7px;
    position: absolute;
    top: -7px;
    right: -8px;
    font-weight: bold;
    z-index: 3;
    min-width: 22px;
    text-align: center;
    line-height: 1.15;
    box-shadow: 0 1px 4px rgba(0,0,0,0.07);
  }
    @media (min-width: 701px) {
      .top-nav {
        max-width: 520px;
        left: 50%;
        transform: translateX(-50%);
        border-radius: 0 0 19px 19px;
        padding-top: 24px;
      }
      .main-logo-colored {
        width: 300px;
        max-width: 380px;
      }
      .lang-switch-center {
        padding-top: 24px;
      }
    }
  </style>

</head>
<body>
  <nav class="top-nav">
    <a href="/index.html" class="nav-btn">
      <i class="fa-solid fa-house"></i>
      <span class="label">Home</span>
    </a>
    <a href="#" class="nav-btn" onclick="showCart();return false;">
      <span style="position:relative;">
        <i class="fa-solid fa-cart-shopping"></i>
        <span class="cart-count" id="cartCount" style="display:none;">0</span>
      </span>
      <span class="label">Warenkorb</span>
    </a>
    <a href="/admin.html" class="nav-btn">
      <i class="fa-solid fa-user"></i>
      <span class="label">Admin</span>
    </a>
  </nav>
  <div style="display: flex; flex-direction: column; align-items: center; margin-top: 12px;">
    <div class="lang-switch-center" style="margin-bottom: 8px; padding-top: 0; position:relative; z-index:2;">
      <button class="lang-text-btn" id="btn-de" type="button">DE</button>
      <button class="lang-text-btn" id="btn-fr" type="button">FR</button>
      <button class="lang-text-btn" id="btn-en" type="button">EN</button>
    </div>
    <div class="main-logo-center">
      <img src="/assets/logo.png" class="main-logo-colored" alt="EHCB Sponser Logo">
    </div>
  </div>
  <div class="main" id="mainView"></div>

  <script>
    // --------- SUPABASE INITIALISIEREN ---------
    const supabaseUrl = 'https://sqlnoaaimkrxrkspqtbq.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxbG5vYWFpbWtyeHJrc3BxdGJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzgyMzAsImV4cCI6MjA3MTI1NDIzMH0.oI201Oqgc2M3ckXePjZAHty1hXVC8M8qptjz8r9QUG4';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // --------- SPRACHE, TEXTE, ETC. ----------
    let lang = localStorage.getItem('sponserlang') || 'de';
    function setLang(l) {
      lang = l; localStorage.setItem('sponserlang', l);
    document.querySelectorAll('.lang-text-btn').forEach(btn=>btn.classList.remove('selected'));
    document.getElementById('btn-'+l).classList.add('selected');
      showHome();
    }
    const txt = {
      "de": {
        title: "SPONSER ORDER – EHC BIEL-BIENNE",
        back: "← Alle Produkte",
        flavor: "Aroma",
        amount: "Menge:",
        addcart: "In den Warenkorb",
        cart: "Warenkorb",
        cartEmpty: "Dein Warenkorb ist leer.",
        cartBack: "← Zurück zum Shop",
        cartRemove: "Entfernen",
        cartTotal: "Total",
        orderNow: "Jetzt bestellen",
        checkoutBack: "← Zurück",
        checkout: "Bestellung abschliessen",
        name: "Vorname/Nachname*:",
        email: "E-Mail*:",
        yourProducts: "Deine Produkte:",
        send: "Bestellung absenden",
        alertName: "Bitte Name angeben!",
        alertEmail: "Bitte gültige E-Mail angeben!",
        sending: "Sende Bestellung...",
        sent: "Bestellung erfolgreich übermittelt! Du erhältst eine Bestätigung per E-Mail.",
        price: "Preis"
      },
      "fr": {
        title: "COMMANDE SPONSER – EHC BIEL-BIENNE",
        back: "← Tous les produits",
        flavor: "Arôme",
        amount: "Quantité:",
        addcart: "Ajouter au panier",
        cart: "Panier",
        cartEmpty: "Votre panier est vide.",
        cartBack: "← Retour à la boutique",
        cartRemove: "Retirer",
        cartTotal: "Total",
        orderNow: "Commander",
        checkoutBack: "← Retour",
        checkout: "Finaliser la commande",
        name: "Prénom/Nom*:",
        email: "E-mail*:",
        yourProducts: "Vos produits:",
        send: "Envoyer la commande",
        alertName: "Merci d’indiquer votre nom!",
        alertEmail: "Merci de saisir une adresse e-mail valide!",
        sending: "Envoi de la commande...",
        sent: "Commande envoyée avec succès ! Vous recevrez une confirmation par e-mail.",
        price: "Prix"
      },
      "en": {
        title: "SPONSER ORDER – EHC BIEL-BIENNE",
        back: "← All Products",
        flavor: "Flavour",
        amount: "Quantity:",
        addcart: "Add to cart",
        cart: "Cart",
        cartEmpty: "Your cart is empty.",
        cartBack: "← Back to Shop",
        cartRemove: "Remove",
        cartTotal: "Total",
        orderNow: "Order now",
        checkoutBack: "← Back",
        checkout: "Complete Order",
        name: "First/Last Name*:",
        email: "E-mail*:",
        yourProducts: "Your products:",
        send: "Submit order",
        alertName: "Please enter your name!",
        alertEmail: "Please enter a valid e-mail address!",
        sending: "Sending order...",
        sent: "Order successfully submitted! You will receive a confirmation email.",
        price: "Price"
      }
    };

    // --------- PRODUKTE & WARENKORB LOGIK ---------
    let products = [];
    let cart = [];
    let view = 'home';
    let selectedProduct = null, selectedVariant = '', selectedProdIdx = -1;

    // PRODUKTE LADEN aus Supabase
    async function fetchProducts() {
      const { data, error } = await supabase.from('produkte').select('*');
      if (error) {
        document.getElementById('mainView').innerHTML = "<br><i>Fehler beim Laden der Produkte!</i>";
        return;
      }
      products = data;
      showHome();
    }

    // Home/Grid
    function showHome() {
      view = 'home';
      let html = '<div class="product-grid">';
      products.forEach((prod, idx) => {
        let desc = prod['beschreibung_' + lang] || prod.beschreibung || "";
        html += `
          <div class="product-card" onclick="showDetail(${idx})">
            ${prod.bild_url ? `<img class="product-img" src="${prod.bild_url}" alt="${prod.produkt}">` : ""}
            <div class="product-title">${prod.produkt}</div>
            <div class="product-desc">${desc}</div>
            <div class="product-price">CHF ${Number(prod.preis).toFixed(2)}</div>
          </div>
        `;
      });
      html += '</div>';
      document.getElementById('mainView').innerHTML = html;
      updateCartCount();
    }
    // Produkt-Detailansicht
    function showDetail(idx) {
      let prod = selectedProduct;
      let variants = (prod.variante || '').split(',').map(s=>s.trim()).filter(Boolean);
      selectedVariant = variants[0] || '';
      let desc = prod['beschreibung_' + lang] || prod.beschreibung || "";
      let html = `
        <div class="detail-page">
          <button class="back-btn" onclick="showHome()">${txt[lang].back}</button>
          <img src="${prod.bild_url}" class="detail-img" alt="${prod.produkt}">
          <div class="detail-title">${prod.produkt}</div>
          <div class="desc-block">${desc}</div>
          ${variants.length > 0 ? `<div class="detail-variant">
            <div style="margin-bottom:5px;color:#444;font-weight:bold;">${txt[lang].flavor}:</div>
            ${variants.map(v =>
              `<button class="variant-btn${selectedVariant==v?' selected':''}" onclick="selectVariant('${v}')">${v}</button>`
            ).join('')}
          </div>` : ''}
          <div class="price-block">CHF ${Number(prod.preis).toFixed(2)}</div>
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:1.2em;">
            <span style="font-size:1.09em;">${txt[lang].amount}</span>
            <input type="number" min="1" max="99" id="detailQty" value="1" class="qty-select" style="margin:0;">
          </div>
          <button class="addcart-btn" onclick="addToCart()">${txt[lang].addcart}</button>
        </div>
      `;
      document.getElementById('mainView').innerHTML = html;
      updateVariantBtns();
    }
    function selectVariant(v) { selectedVariant = v; updateVariantBtns();}
    function updateVariantBtns() {
      document.querySelectorAll('.variant-btn').forEach(btn => {
        if (btn.textContent.trim() === selectedVariant) btn.classList.add('selected'); else btn.classList.remove('selected');
      });
    }

    // Warenkorb
    function addToCart() {
      let qty = +document.getElementById('detailQty').value || 1;
      let prod = selectedProduct;
      let key = prod.produkt + '|' + selectedVariant;
      let idx = cart.findIndex(item => item.key === key);
      if (idx > -1) {
        cart[idx].qty += qty;
      } else {
        cart.push({
          key, produkt: prod.produkt, variante: selectedVariant,
          preis: prod.preis, bild_url: prod.bild_url, qty
        });
      }
      showAddToCartFeedback();
      showCart();
    function showAddToCartFeedback() {
      let fb = document.createElement('div');
      fb.className = 'cart-feedback';
      fb.innerHTML = '✔️ Produkt hinzugefügt!';
      document.body.appendChild(fb);
      setTimeout(() => { fb.classList.add('show'); }, 10);
      setTimeout(() => { fb.classList.remove('show'); setTimeout(()=>fb.remove(),300); }, 1200);
    }
    }
    function showCart() {
      view = 'cart';
      let html = `<div class="cart-page"><button class="back-btn" onclick="showHome()">${txt[lang].cartBack}</button>`;
      if (!cart.length) {
        html += `<div class="emptycart">${txt[lang].cartEmpty}</div></div>`;
        document.getElementById('mainView').innerHTML = html;
        updateCartCount();
        return;
      }
      let total = 0;
      html += cart.map((item,i) => {
        let sum = (+item.preis) * (+item.qty);
        total += sum;
        return `
          <div class="cart-item">
            <img src="${item.bild_url}" class="cart-img" alt="">
            <div class="cart-info">
              <div class="cart-prod">${item.produkt}</div>
              ${item.variante ? `<div class="cart-variant">${item.variante}</div>` : ""}
            </div>
            <input type="number" min="1" max="99" value="${item.qty}" class="cart-qty" onchange="changeCartQty(${i},this.value)">
            <div class="cart-price">CHF ${Number(sum).toFixed(2)}</div>
            <button class="cart-remove" onclick="removeCart(${i})">&times;</button>
          </div>
        `;
      }).join('');
      html += `<div class="cart-total">${txt[lang].cartTotal}: CHF ${Number(total).toFixed(2)}</div>
        <button class="order-btn" onclick="checkout()">${txt[lang].orderNow}</button>`;
      document.getElementById('mainView').innerHTML = html;
      updateCartCount();
    }

    async function submitOrder() {
      let name = document.getElementById('orderName').value.trim();
      let email = document.getElementById('orderEmail').value.trim();
      if (!name) return alert(txt[lang].alertName);
      if (!email || !email.includes("@")) return alert(txt[lang].alertEmail);
      let ordered = cart.map(item=>({
        produkt: item.produkt,
        geschmack: item.variante,
        preis: item.preis,
        menge: item.qty
      }));

      document.getElementById('orderResult').innerHTML = "<br><i>" + txt[lang].sending + "</i>";

      // 1. Bestellung in Supabase speichern
      let { error } = await supabase.from('bestellungen').insert([{
        name,
        email,
        produkte: ordered,
        timestamp: new Date().toISOString()
      }]);
      if (error) {
        alert("Fehler beim Speichern: " + error.message);
        return;
      }

      // 2. E-Mail an Kunde + Admin senden (Resend-API via Serverless)
      fetch('/api/send-mail', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          name, email, ordered, lang,
          to: email,                // Kunde
          admin: "n.guyaz@icloud.com" // Admin
        })
      })
      .then(res => res.json())
      .then(data => {
        cart = [];
        showHome();
        alert(txt[lang].sent);
      })
      .catch(err => {
        alert("Fehler beim Senden der Bestätigungsmail.");
      });
    }

    // Sprachwahl-Buttons initialisieren (jetzt als Text-Buttons)
    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById('btn-de').onclick = () => setLang('de');
      document.getElementById('btn-fr').onclick = () => setLang('fr');
      document.getElementById('btn-en').onclick = () => setLang('en');
      setLang(lang);
      // Sprach-Button Status initialisieren
      document.querySelectorAll('.lang-text-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.getElementById('btn-' + lang).classList.add('selected');
    });
    window.onload = fetchProducts;
</script>
</script>
</body>
</html>