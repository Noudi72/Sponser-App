<!DOCTYPE html>
<html lang="de">
<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <meta charset="UTF-8">
  <title>Sponser Bestellshop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <link rel="icon" type="image/png" href="/assets/icon.png">
  <link rel="apple-touch-icon" href="/assets/icon.png">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    html, body { margin:0; padding:0; background:#fff; color:#222; font-family: Arial, sans-serif; min-height:100vh; width:100vw; overflow-x:hidden;}
    .header-center { display: flex; flex-direction: column; align-items: center; margin-top: 10px; margin-bottom: 8px;}
    .main-logo { width: 135px; height:auto; margin-bottom:5px;}
    .lang-switch { display:flex; gap:11px; justify-content:center; margin: 0 0 5px 0;}
    .lang-btn { background:none; border:none; cursor:pointer; outline:none; opacity:.82; }
    .lang-btn.selected, .lang-btn:focus { opacity:1; border-bottom:2.5px solid #e10c18;}
    .lang-flag { height:25px; width:32px; border-radius:7px;}
    .order-title { font-size: 1.22em; font-weight: bold; letter-spacing: 0.5px; color: #e10c18; margin-bottom: 10px; margin-top: 2px; text-align: center;}
    .sticky-cart-bar { position: sticky; top: 0; z-index: 30; background: #fff; display: flex; justify-content: center; align-items: center; min-height: 48px; border-bottom: 1px solid #ececec;}
    .main-cart { font-size: 2.1em; margin: 0; cursor: pointer; color: #e10c18; display: flex; align-items: center; justify-content: center; position: relative;}
    .main-cart img { height: 45px; width: 45px; filter: grayscale(20%);}
    .cart-count { background:#e10c18; color:#fff; font-size:1em; border-radius:50%; padding:2px 8px; position:absolute; top:3px; left:31px; font-weight:bold; z-index:2;}
    .main {
      width: 100vw;
      max-width: 100vw;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    .product-grid {
      display: flex;
      flex-direction: column;
      gap: 0;
      width: 100vw;
      max-width: 100vw;
    }
    .product-card {
      background:#fff;
      border-radius: 0;
      box-shadow: none;
      width: 100vw;
      margin: 0;
      padding: 1.15em 0 1.25em 0;
      border-bottom: 1.5px solid #f3f3f3;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition:.13s;
      cursor:pointer;
    }
    .product-card:hover { background: #fafafc; }
    .product-img { width:88px; height:88px; border-radius:9px; object-fit:contain; margin-bottom:0.6em;}
    .product-title { font-weight:bold; font-size:1.17em; text-align:center; }
    .product-price { color:#e10c18; font-size:1.18em; font-weight:bold; margin-top:7px;}
    .product-desc { color:#444; font-size:1.05em; text-align:center; margin-top:0.5em; min-height:36px;}
    .detail-page {
      width: 100vw;
      max-width: 100vw;
      margin: 0;
      padding: 1.2em 0 1.2em 0;
      border-radius: 0;
      background: #fff;
    }
    .detail-img { width:160px; height:160px; object-fit:contain; background:#f7f7f7; border-radius:16px; display:block; margin:0 auto 1em auto;}
    .detail-title { font-size: 1.18em; font-weight:bold; margin-bottom:0.18em;}
    .desc-block {margin:0.48em 0 1.18em 0; color:#444; font-size:1em;}
    .detail-variant {margin:0.55em 0;}
    .variant-btn { padding:11px 18px; border:1.5px solid #ccc; border-radius:14px; margin-right:6px; background:#f7f7f7; font-size:1.09em; cursor:pointer; margin-bottom:7px;}
    .variant-btn.selected { border:2px solid #e10c18; background:#fff0f2; color:#e10c18; font-weight:bold;}
    .price-block {font-size:1.12em;font-weight:bold;margin:0.35em 0 0.6em 0;color:#e10c18;}
    .qty-select {font-size:1.09em;width:56px;padding:7px 7px;border-radius:10px;border:1.4px solid #bbb;text-align:center;}
    .addcart-btn { background:#e10c18;color:#fff;font-weight:bold;font-size:1.12em;padding:1.03em 0;border-radius:12px;border:none;margin:0.8em 0 0 0;cursor:pointer;width:100%;}
    .addcart-btn:active {background:#bb0920;}
    .back-btn { background:#eee;border:none;color:#333;padding:0.5em 1.5em;border-radius:10px;cursor:pointer;margin-bottom:1.1em;}
    .cart-page {
      width:100vw; 
      max-width:100vw; 
      margin:0 auto;
    }
    .cart-item {display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #f0f0f0;padding:0.9em 0;}
    .cart-img {width:53px;height:53px;object-fit:contain;background:#f7f7f7;border-radius:8px;}
    .cart-info {flex:1;margin-left:10px;}
    .cart-prod {font-weight:bold;font-size:1.06em;}
    .cart-variant {font-size:1em;color:#444;}
    .cart-price {color:#e10c18;font-weight:bold;font-size:1.09em;}
    .cart-qty {width:42px;text-align:center;font-size:1em;margin:0 4px;border-radius:7px;border:1.2px solid #bbb;padding:4px;}
    .cart-remove {color:#e10c18;background:none;border:none;cursor:pointer;font-size:1.38em;}
    .cart-total {font-size:1.14em;font-weight:bold;text-align:right;margin:1.08em 0 1.08em 0;}
    .order-btn {background:#e10c18;color:#fff;font-weight:bold;font-size:1.15em;padding:1.04em 0;border-radius:11px;border:none;width:100%;margin-top:1.18em;}
    .emptycart {color:#aaa;text-align:center;margin:2.5em 0;}
    @media (min-width:701px){
      .main, .product-grid, .product-card, .detail-page, .cart-page { max-width:520px; width:100%; margin:0 auto;}
    }
  </style>
</head>
<body>
  <div class="header-center">
    <img src="/assets/logo.png" class="main-logo" alt="EHCB Sponser Logo">
    <div class="lang-switch">
      <button class="lang-btn" id="btn-de"><img src="https://flagcdn.com/de.svg" class="lang-flag" alt="DE"></button>
      <button class="lang-btn" id="btn-fr"><img src="https://flagcdn.com/fr.svg" class="lang-flag" alt="FR"></button>
      <button class="lang-btn" id="btn-en"><img src="https://flagcdn.com/gb.svg" class="lang-flag" alt="EN"></button>
    </div>
    <div class="order-title" id="orderTitle">SPONSER ORDER – EHC BIEL-BIENNE</div>
  </div>
  <div class="sticky-cart-bar">
    <div class="main-cart" onclick="showCart()" style="position:relative;">
  <img src="https://img.icons8.com/material-outlined/96/000000/shopping-cart--v1.png" alt="Warenkorb">
      <div style="text-align:center;">
        <img src="https://img.icons8.com/material-outlined/96/000000/shopping-cart--v1.png" alt="Warenkorb">
        <br>
        <a href="/admin.html" class="btn btn-secondary" style="font-size:1rem;font-weight:400;padding:0.5em 1.5em;min-width:160px;margin-top:12px;">Zur Bestellübersicht (Admin)</a>
      </div>
      <span class="cart-count" id="cartCount" style="display:none;">0</span>
    </div>
  </div>
  <div class="main" id="mainView"></div>
  <div style="text-align:center;margin:30px 0 0 0;">
    <a href="/admin.html" class="btn btn-secondary btn-lg" style="font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-top:10px;">Admin-Bestellungen</a>
  </div>
  <script>
    // --------- SUPABASE INITIALISIEREN ---------
    const supabaseUrl = 'https://sqlnoaaimkrxrkspqtbq.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxbG5vYWFpbWtyeHJrc3BxdGJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzgyMzAsImV4cCI6MjA3MTI1NDIzMH0.oI201Oqgc2M3ckXePjZAHty1hXVC8M8qptjz8r9QUG4';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // --------- SPRACHE, TEXTE, ETC. ----------
    let lang = localStorage.getItem('sponserlang') || 'de';
    function setLang(l) {
      lang = l; localStorage.setItem('sponserlang', l);
      document.querySelectorAll('.lang-btn').forEach(btn=>btn.classList.remove('selected'));
      document.getElementById('btn-'+l).classList.add('selected');
      showHome();
    }
    const txt = {
      "de": {
        title: "SPONSER ORDER – EHC BIEL-BIENNE",
        back: "← Alle Produkte",
        flavor: "Aroma",
        amount: "Menge:",
        addcart: "In den Warenkorb",
        cart: "Warenkorb",
        cartEmpty: "Dein Warenkorb ist leer.",
        cartBack: "← Zurück zum Shop",
        cartRemove: "Entfernen",
        cartTotal: "Total",
        orderNow: "Jetzt bestellen",
        checkoutBack: "← Zurück",
        checkout: "Bestellung abschliessen",
        name: "Vorname/Nachname*:",
        email: "E-Mail*:",
        yourProducts: "Deine Produkte:",
        send: "Bestellung absenden",
        alertName: "Bitte Name angeben!",
        alertEmail: "Bitte gültige E-Mail angeben!",
        sending: "Sende Bestellung...",
        sent: "Bestellung erfolgreich übermittelt! Du erhältst eine Bestätigung per E-Mail.",
        price: "Preis"
      },
      "fr": {
        title: "COMMANDE SPONSER – EHC BIEL-BIENNE",
        back: "← Tous les produits",
        flavor: "Arôme",
        amount: "Quantité:",
        addcart: "Ajouter au panier",
        cart: "Panier",
        cartEmpty: "Votre panier est vide.",
        cartBack: "← Retour à la boutique",
        cartRemove: "Retirer",
        cartTotal: "Total",
        orderNow: "Commander",
        checkoutBack: "← Retour",
        checkout: "Finaliser la commande",
        name: "Prénom/Nom*:",
        email: "E-mail*:",
        yourProducts: "Vos produits:",
        send: "Envoyer la commande",
        alertName: "Merci d’indiquer votre nom!",
        alertEmail: "Merci de saisir une adresse e-mail valide!",
        sending: "Envoi de la commande...",
        sent: "Commande envoyée avec succès ! Vous recevrez une confirmation par e-mail.",
        price: "Prix"
      },
      "en": {
        title: "SPONSER ORDER – EHC BIEL-BIENNE",
        back: "← All Products",
        flavor: "Flavour",
        amount: "Quantity:",
        addcart: "Add to cart",
        cart: "Cart",
        cartEmpty: "Your cart is empty.",
        cartBack: "← Back to Shop",
        cartRemove: "Remove",
        cartTotal: "Total",
        orderNow: "Order now",
        checkoutBack: "← Back",
        checkout: "Complete Order",
        name: "First/Last Name*:",
        email: "E-mail*:",
        yourProducts: "Your products:",
        send: "Submit order",
        alertName: "Please enter your name!",
        alertEmail: "Please enter a valid e-mail address!",
        sending: "Sending order...",
        sent: "Order successfully submitted! You will receive a confirmation email.",
        price: "Price"
      }
    };

    // --------- PRODUKTE & WARENKORB LOGIK ---------
    let products = [];
    let cart = [];
    let view = 'home';
    let selectedProduct = null, selectedVariant = '', selectedProdIdx = -1;

    // PRODUKTE LADEN aus Supabase
    async function fetchProducts() {
      const { data, error } = await supabase.from('produkte').select('*');
      if (error) {
        document.getElementById('mainView').innerHTML = "<br><i>Fehler beim Laden der Produkte!</i>";
        return;
      }
      products = data;
      showHome();
    }

    // Home/Grid
    function showHome() {
      document.getElementById('orderTitle').innerText = txt[lang].title;
      view = 'home';
      let html = '<div class="product-grid">';
      products.forEach((prod, idx) => {
        let desc = prod['beschreibung_' + lang] || prod.beschreibung || "";
        html += `
          <div class="product-card" onclick="showDetail(${idx})">
            ${prod.bild_url ? `<img class="product-img" src="${prod.bild_url}" alt="${prod.produkt}">` : ""}
            <div class="product-title">${prod.produkt}</div>
            <div class="product-desc">${desc}</div>
            <div class="product-price">CHF ${Number(prod.preis).toFixed(2)}</div>
          </div>
        `;
      });
      html += '</div>';
      document.getElementById('mainView').innerHTML = html;
      updateCartCount();
    }

    // Produkt-Detailansicht
    function showDetail(idx) {
      view = 'detail'; selectedProduct = products[idx]; selectedProdIdx = idx;
      let prod = selectedProduct;
      let variants = (prod.variante || '').split(',').map(s=>s.trim()).filter(Boolean);
      selectedVariant = variants[0] || '';
      let desc = prod['beschreibung_' + lang] || prod.beschreibung || "";
      let html = `
        <div class="detail-page">
          <button class="back-btn" onclick="showHome()">${txt[lang].back}</button>
          <img src="${prod.bild_url}" class="detail-img" alt="${prod.produkt}">
          <div class="detail-title">${prod.produkt}</div>
          <div class="desc-block">${desc}</div>
          ${variants.length > 0 ? `<div class="detail-variant">
            <div style="margin-bottom:5px;color:#444;font-weight:bold;">${txt[lang].flavor}:</div>
            ${variants.map(v =>
              `<button class="variant-btn${selectedVariant==v?' selected':''}" onclick="selectVariant('${v}')">${v}</button>`
            ).join('')}
          </div>` : ''}
          <div class="price-block">CHF ${Number(prod.preis).toFixed(2)}</div>
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:1.2em;">
            <span style="font-size:1.09em;">${txt[lang].amount}</span>
            <input type="number" min="1" max="99" id="detailQty" value="1" class="qty-select" style="margin:0;">
          </div>
          <button class="addcart-btn" onclick="addToCart()">${txt[lang].addcart}</button>
        </div>
      `;
      document.getElementById('mainView').innerHTML = html;
      updateVariantBtns();
    }
    function selectVariant(v) { selectedVariant = v; updateVariantBtns();}
    function updateVariantBtns() {
      document.querySelectorAll('.variant-btn').forEach(btn => {
        if (btn.textContent.trim() === selectedVariant) btn.classList.add('selected'); else btn.classList.remove('selected');
      });
    }

    // Warenkorb
    function addToCart() {
      let qty = +document.getElementById('detailQty').value || 1;
      let prod = selectedProduct;
      let key = prod.produkt + '|' + selectedVariant;
      let idx = cart.findIndex(item => item.key === key);
      if (idx > -1) {
        cart[idx].qty += qty;
      } else {
        cart.push({
          key, produkt: prod.produkt, variante: selectedVariant,
          preis: prod.preis, bild_url: prod.bild_url, qty
        });
      }
      showCart();
    }
    function showCart() {
      view = 'cart';
      let html = `<div class="cart-page"><button class="back-btn" onclick="showHome()">${txt[lang].cartBack}</button>`;
      if (!cart.length) {
        html += `<div class="emptycart">${txt[lang].cartEmpty}</div></div>`;
        document.getElementById('mainView').innerHTML = html;
        updateCartCount();
        return;
      }
      let total = 0;
      html += cart.map((item,i) => {
        let sum = (+item.preis) * (+item.qty);
        total += sum;
        return `
          <div class="cart-item">
            <img src="${item.bild_url}" class="cart-img">
            <div class="cart-info">
              <div class="cart-prod">${item.produkt}</div>
              ${item.variante ? `<div class="cart-variant">${item.variante}</div>` : ""}
            </div>
            <input type="number" min="1" max="99" value="${item.qty}" class="cart-qty" onchange="changeCartQty(${i},this.value)">
            <div class="cart-price">CHF ${Number(sum).toFixed(2)}</div>
            <button class="cart-remove" onclick="removeCart(${i})">&times;</button>
          </div>
        `;
      }).join('');
      html += `<div class="cart-total">${txt[lang].cartTotal}: CHF ${Number(total).toFixed(2)}</div>
        <button class="order-btn" onclick="checkout()">${txt[lang].orderNow}</button>
      </div>`;
      document.getElementById('mainView').innerHTML = html;
      updateCartCount();
    }
    function changeCartQty(idx,val){
      let qty = Math.max(1,Math.min(99,parseInt(val)||1));
      cart[idx].qty = qty; showCart();
    }
    function removeCart(idx){ cart.splice(idx,1); showCart();}
    function updateCartCount() {
      let n = cart.reduce((sum,i)=>sum+i.qty,0);
      document.getElementById('cartCount').innerText = n;
      document.getElementById('cartCount').style.display = n>0?'':'none';
    }

    // Checkout und Bestellung absenden (inkl. Mail)
    function checkout() {
      let total = cart.reduce((sum,i)=>sum+((+i.preis)*(+i.qty)),0);
      let html = `
        <div class="cart-page">
          <button class="back-btn" onclick="showCart()">${txt[lang].checkoutBack}</button>
          <h3>${txt[lang].checkout}</h3>
          <div style="margin-bottom:1em;">
            <label style="font-weight:bold;">${txt[lang].name}</label>
            <input id="orderName" type="text" style="width:100%;font-size:1.08em;padding:0.6em;" required>
          </div>
          <div style="margin-bottom:1em;">
            <label style="font-weight:bold;">${txt[lang].email}</label>
            <input id="orderEmail" type="email" style="width:100%;font-size:1.08em;padding:0.6em;" required>
          </div>
          <div style="margin:1.2em 0 0.6em 0;font-weight:500;font-size:1.1em;">${txt[lang].yourProducts}</div>
          ${cart.map(item=>`
            <div style="display:flex;align-items:center;justify-content:space-between;padding:0.6em 0;border-bottom:1px solid #eee;">
              <div>
                <div style="font-weight:bold">${item.produkt}</div>
                ${item.variante?`<div style="color:#555">${item.variante}</div>`:""}
                <div style="color:#999;font-size:0.98em;">CHF ${Number(item.preis).toFixed(2)} x ${item.qty}</div>
              </div>
              <div style="font-weight:bold;">CHF ${(Number(item.preis) * item.qty).toFixed(2)}</div>
            </div>
          `).join('')}
          <div class="cart-total" style="margin:1.4em 0 0.8em 0;">${txt[lang].cartTotal}: CHF ${Number(total).toFixed(2)}</div>
          <button class="order-btn" onclick="submitOrder()">${txt[lang].send}</button>
        </div>
        <div id="orderResult"></div>
      `;
      document.getElementById('mainView').innerHTML = html;
    }

    async function submitOrder() {
      let name = document.getElementById('orderName').value.trim();
      let email = document.getElementById('orderEmail').value.trim();
      if (!name) return alert(txt[lang].alertName);
      if (!email || !email.includes("@")) return alert(txt[lang].alertEmail);
      let ordered = cart.map(item=>({
        produkt: item.produkt,
        geschmack: item.variante,
        preis: item.preis,
        menge: item.qty
      }));

      document.getElementById('orderResult').innerHTML = "<br><i>" + txt[lang].sending + "</i>";

      // 1. Bestellung in Supabase speichern
      let { error } = await supabase.from('bestellungen').insert([{
        name,
        email,
        produkte: ordered,
        timestamp: new Date().toISOString()
      }]);
      if (error) {
        alert("Fehler beim Speichern: " + error.message);
        return;
      }

      // 2. E-Mail an Kunde + Admin senden (Resend-API via Serverless)
      fetch('/api/send-mail', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          name, email, ordered, lang,
          to: email,                // Kunde
          admin: "n.guyaz@icloud.com" // Admin
        })
      })
      .then(res => res.json())
      .then(data => {
        cart = [];
        showHome();
        alert(txt[lang].sent);
      })
      .catch(err => {
        alert("Fehler beim Senden der Bestätigungsmail.");
      });
    }

    // Sprachwahl-Buttons initialisieren
    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById('btn-de').onclick = () => setLang('de');
      document.getElementById('btn-fr').onclick = () => setLang('fr');
      document.getElementById('btn-en').onclick = () => setLang('en');
      setLang(lang);
    });
    window.onload = fetchProducts;
  </script>
</body>
</html>