<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin – Bestellübersicht</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div id="pwPrompt" style="max-width:400px;margin:60px auto;text-align:center;">
      <img src="/assets/logo.png" alt="EHCB Sponser Logo" style="height:60px;margin-bottom:20px;">
      <h2 class="mb-3">Admin Login</h2>
      <input type="password" id="pwInput" class="form-control mb-2" placeholder="Passwort">
      <button id="pwBtn" class="btn btn-primary">Login</button>
      <div id="pwError" class="text-danger mt-2" style="display:none;">Falsches Passwort!</div>
    </div>
    <div id="adminContent" style="display:none;">
      <div class="d-flex align-items-center mb-4">
        <img src="/assets/logo.png" alt="EHCB Sponser Logo" style="height:60px;margin-right:20px;">
        <h2 class="mb-0">Bestellübersicht</h2>
      </div>
      <div class="mb-3 d-flex gap-2">
        <a href="/index.html" class="btn btn-secondary">Zurück zum Shop</a>
        <button id="exportExcel" class="btn btn-success">Export als Excel</button>
        <button id="exportPDF" class="btn btn-danger">Export als PDF</button>
        <a href="/admin-sort/" class="btn btn-info text-white" id="openSort">Artikel sortieren</a>
        <a href="/admin-products.html" class="btn btn-outline-primary">Produkte verwalten</a>
      </div>
      <div id="ordersTable"></div>
      <div class="d-flex align-items-center gap-3 mt-4">
        <div>
          <label class="form-label mb-1">Zeitraum Zusammenfassung:</label>
          <select id="summaryDays" class="form-select form-select-sm">
            <option value="7">Letzte 7 Tage</option>
            <option value="14">Letzte 14 Tage</option>
            <option value="21">Letzte 21 Tage</option>
            <option value="31">Letzte 31 Tage</option>
          </select>
        </div>
        <div class="ms-auto text-end">
          <small class="text-muted">Wähle Zeitraum für die Zusammenfassung und Exporte</small>
        </div>
      </div>
      <div id="weeklySummary" class="mt-3"></div>
      <div class="mb-3">
  <button id="exportSummaryExcel" class="btn btn-success btn-sm">Zusammenfassung als Excel exportieren</button>
  <button id="exportSummaryPDF" class="btn btn-danger btn-sm ms-2">Zusammenfassung als PDF exportieren</button>
      </div>
    <div class="mb-2"><small class="text-muted">Hinweis: Wenn Excel Produkte nicht untereinander anzeigt, markiere die Spalte und aktiviere 'Wrap Text' (Zellen formatieren → Alignment → Wrap text).</small></div>
    </div>
  </div>
  <script>
    document.getElementById('exportSummaryPDF').onclick = async function() {
      const selectedDaysForExport = Number(document.getElementById('summaryDays')?.value || 7);
      if (!weeklySummaryData.length) return alert(`Keine Bestellungen in den letzten ${selectedDaysForExport} Tagen.`);
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
      // Beide Logos einfügen
      const ehcbLogoUrl = '/assets/Logo_EHCB.png';
      const sponserLogoUrl = '/assets/Sponser_Logo.png';
      let ehcbImgData = null;
      let sponserImgData = null;
      
      // EHCB Logo laden
      try {
        const response = await fetch(ehcbLogoUrl);
        const blob = await response.blob();
        const reader = new FileReader();
        ehcbImgData = await new Promise(resolve => {
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(blob);
        });
      } catch(e) {}
      
      // Sponser Logo laden
      try {
        const response = await fetch(sponserLogoUrl);
        const blob = await response.blob();
        const reader = new FileReader();
        sponserImgData = await new Promise(resolve => {
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(blob);
        });
      } catch(e) {}
      
      const pageWidth = 297;
      const maxLogoHeight = 30; // maximal 30mm hoch
      const logoGap = 10; // Abstand zwischen den Logos
      const logoY = 10;
      let logosLoaded = false;
      
      if (ehcbImgData && sponserImgData) {
        logosLoaded = true;
        // Beide Logos laden und Größe berechnen
        const ehcbImg = new Image();
        ehcbImg.src = ehcbImgData;
        await new Promise(resolve => { ehcbImg.onload = resolve; });
        
        const sponserImg = new Image();
        sponserImg.src = sponserImgData;
        await new Promise(resolve => { sponserImg.onload = resolve; });
        
        // EHCB Logo Größe berechnen
        let ehcbLogoHeight = maxLogoHeight;
        let ehcbLogoWidth = (ehcbImg.width / ehcbImg.height) * ehcbLogoHeight;
        if (ehcbLogoHeight > maxLogoHeight) {
          ehcbLogoHeight = maxLogoHeight;
          ehcbLogoWidth = (ehcbImg.width / ehcbImg.height) * ehcbLogoHeight;
        }
        
        // Sponser Logo kleiner machen (70% der EHCB Logo Höhe)
        let sponserLogoHeight = ehcbLogoHeight * 0.7;
        let sponserLogoWidth = (sponserImg.width / sponserImg.height) * sponserLogoHeight;
        
        // Beide Logos zentriert untereinander platzieren
        const ehcbX = (pageWidth - ehcbLogoWidth) / 2;
        const sponserX = (pageWidth - sponserLogoWidth) / 2;
        const sponserY = logoY + ehcbLogoHeight + logoGap;
        
        doc.addImage(ehcbImgData, 'PNG', ehcbX, logoY, ehcbLogoWidth, ehcbLogoHeight);
        doc.addImage(sponserImgData, 'PNG', sponserX, sponserY, sponserLogoWidth, sponserLogoHeight);
        // Empfängeradresse oben links
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        const addrY = logoY + 5;
        doc.text('Empfänger:', 10, addrY);
        doc.setFont('helvetica', 'normal');
        doc.text('EHC Biel Sport AG', 10, addrY + 5);
        doc.text('Noël Guyaz', 10, addrY + 10);
        doc.text('Boulevard des Sports 18', 10, addrY + 15);
        doc.text('2504 Biel', 10, addrY + 20);
        doc.text('Schweiz', 10, addrY + 25);
        // title below logo
        doc.setFontSize(16);
        const totalLogoHeight = ehcbLogoHeight + logoGap + sponserLogoHeight;
        const titleY = logoY + totalLogoHeight + 11;
  doc.text('Bestellung EHC Biel-Bienne Spirit', pageWidth / 2, titleY, {align: 'center'});
        doc.setFontSize(11);
        var startY = titleY + 10;
      } else {
        // Empfängeradresse oben links (wenn kein Logo)
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.text('Empfänger:', 10, 15);
        doc.setFont('helvetica', 'normal');
        doc.text('EHC Biel Sport AG', 10, 20);
        doc.text('Noël Guyaz', 10, 25);
        doc.text('Boulevard des Sports 18', 10, 30);
        doc.text('2504 Biel', 10, 35);
        doc.text('Schweiz', 10, 40);
        doc.setFontSize(16);
  doc.text('Bestellung EHC Biel-Bienne Spirit', 297/2, 33, {align:'center'});
        doc.setFontSize(11);
        var startY = 40;
      }
  // Tabellenkopf
  doc.setFont('helvetica', 'bold');
  doc.text('Produkt', 10, startY);
  doc.text('Geschmack', 120, startY);
  doc.text('Menge', 180, startY);
  doc.text('Preis (CHF)', 210, startY);
  doc.setFont('helvetica', 'normal');
  startY += 10;
      for (const row of weeklySummaryData) {
        // Produkt mit maximaler Breite bis vor Geschmack
        const produktText = String(row[0]);
        const maxProduktWidth = 105; // Platz bis vor Geschmack (120 - 15mm Abstand)
        const splitProdukt = doc.splitTextToSize(produktText, maxProduktWidth);
        doc.text(splitProdukt, 10, startY);
        // Geschmack, Menge und Preis in der Höhe der ersten Zeile des Produkts
        const firstLineY = startY;
        doc.text(String(row[1]), 120, firstLineY);
        doc.text(String(row[2]), 180, firstLineY);
        doc.text(String(row[3]), 210, firstLineY);
        // startY für die nächste Zeile anpassen, falls Produkt mehrzeilig ist
        startY += Math.max(8, splitProdukt.length * 6);
        if (startY > 190) { 
          doc.addPage(); 
          if (logosLoaded && ehcbImgData && sponserImgData) {
            const ehcbImg = new Image();
            ehcbImg.src = ehcbImgData;
            await new Promise(resolve => { ehcbImg.onload = resolve; });
            const sponserImg = new Image();
            sponserImg.src = sponserImgData;
            await new Promise(resolve => { sponserImg.onload = resolve; });
            const smallEhcbHeight = 18;
            const ehcbSmallWidth = (ehcbImg.width / ehcbImg.height) * smallEhcbHeight;
            const smallSponserHeight = smallEhcbHeight * 0.7;
            const sponserSmallWidth = (sponserImg.width / sponserImg.height) * smallSponserHeight;
            const ehcbSmallX = (297 - ehcbSmallWidth) / 2;
            const sponserSmallX = (297 - sponserSmallWidth) / 2;
            const sponserSmallY = 8 + smallEhcbHeight + 5;
            doc.addImage(ehcbImgData, 'PNG', ehcbSmallX, 8, ehcbSmallWidth, smallEhcbHeight);
            doc.addImage(sponserImgData, 'PNG', sponserSmallX, sponserSmallY, sponserSmallWidth, smallSponserHeight);
          }
          // Empfängeradresse auch auf weiteren Seiten
          doc.setFontSize(10);
          doc.setFont('helvetica', 'bold');
          doc.text('Empfänger:', 10, 15);
          doc.setFont('helvetica', 'normal');
          doc.text('EHC Biel Sport AG', 10, 20);
          doc.text('Noël Guyaz', 10, 25);
          doc.text('Boulevard des Sports 18', 10, 30);
          doc.text('2504 Biel', 10, 35);
          doc.text('Schweiz', 10, 40);
          startY = 45;
        }
      }
      doc.save('woechentliche-zusammenfassung.pdf');
    };
  let weeklySummaryData = [];
    const supabaseUrl = 'https://sqlnoaaimkrxrkspqtbq.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxbG5vYWFpbWtyeHJrc3BxdGJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzgyMzAsImV4cCI6MjA3MTI1NDIzMH0.oI201Oqgc2M3ckXePjZAHty1hXVC8M8qptjz8r9QUG4';
    // Prüfe ob supabase bereits existiert (verhindert doppelte Deklaration)
    if (typeof window.supabaseClient === 'undefined') {
      window.supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
    }
    // Verwende window.supabaseClient direkt statt lokaler Variable, um Konflikte zu vermeiden
    const supabaseClient = window.supabaseClient;

    let ordersData = [];
    async function loadOrders() {
      document.getElementById('exportPDF').disabled = true;
      const { data, error } = await supabaseClient
        .from('bestellungen')
        .select('*')
        .order('timestamp', { ascending: false });
      if (error) {
        document.getElementById('ordersTable').innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Bestellungen!</div>';
        return;
      }
  ordersData = data;
  document.getElementById('exportPDF').disabled = false;
      let html = `<table class="table table-bordered table-striped"><thead><tr><th>ID</th><th>Name</th><th>Produkte</th><th>Total (CHF)</th><th>Datum</th><th>Löschen</th></tr></thead><tbody>`;
      for (const order of data) {
        let produkte = '';
        try {
          const arr = typeof order.produkte === 'string' ? JSON.parse(order.produkte) : order.produkte;
          produkte = arr.map(p => `${p.produkt} (${p.geschmack}) x${p.menge} – CHF ${Number(p.preis).toFixed(2)}`).join('; ');
          // compute total for the order
          const totalSum = arr.reduce((s, p) => s + Number(p.preis) * Number(p.menge), 0);
        } catch(e) {
          produkte = order.produkte;
          const totalSum = 0;
        }
        // if totalSum is not in scope (caught), compute from string fallback
        let displayTotal = '';
        try {
          const arr2 = typeof order.produkte === 'string' ? JSON.parse(order.produkte) : order.produkte;
          const total = arr2.reduce((s, p) => s + Number(p.preis) * Number(p.menge), 0);
          displayTotal = `CHF ${total.toFixed(2)}`;
        } catch(e) {
          displayTotal = '';
        }
        html += `<tr><td>${order.id}</td><td>${order.name}</td><td>${produkte}</td><td>${displayTotal}</td><td>${new Date(order.timestamp).toLocaleString()}</td><td><button class='btn btn-sm btn-danger' onclick='deleteOrder(${order.id})'>Löschen</button></td></tr>`;
      }
      html += '</tbody></table>';
      document.getElementById('ordersTable').innerHTML = html;
      // compute and show total of displayed orders
      try {
        const visibleOrders = data;
        const grandTotal = visibleOrders.reduce((s, o) => {
          try {
            const arr = typeof o.produkte === 'string' ? JSON.parse(o.produkte) : o.produkte;
            return s + arr.reduce((ss, p) => ss + Number(p.preis) * Number(p.menge), 0);
          } catch(e) { return s; }
        }, 0);
        const totalHtml = `<div class="mt-2"><strong>Gesamtsumme (angezeigte Bestellungen):</strong> CHF ${grandTotal.toFixed(2)}</div>`;
        document.getElementById('ordersTable').insertAdjacentHTML('afterend', totalHtml);
      } catch(e) {}

      // Wöchentliche Zusammenfassung
  // determine timeframe from selector (default 7 days)
  const selectedDays = Number(document.getElementById('summaryDays')?.value || 7);
  const since = Date.now() - selectedDays * 24 * 60 * 60 * 1000;
  const weeklyOrders = data.filter(order => new Date(order.timestamp).getTime() >= since);
      const summaryMap = {};
      weeklySummaryData = [];
      for (const order of weeklyOrders) {
        let arr = [];
        try {
          arr = typeof order.produkte === 'string' ? JSON.parse(order.produkte) : order.produkte;
        } catch(e) {
          arr = [];
        }
        for (const p of arr) {
          const key = `${p.produkt}|${p.geschmack}|${p.preis}`;
          if (!summaryMap[key]) {
            summaryMap[key] = { produkt: p.produkt, geschmack: p.geschmack, preis: p.preis, menge: 0 };
          }
          summaryMap[key].menge += Number(p.menge);
        }
      }
      let summaryHtml = `<h4>Zusammenfassung (${selectedDays} Tage)</h4>`;
      if (Object.keys(summaryMap).length === 0) {
        summaryHtml += `<div class='text-muted'>Keine Bestellungen in den letzten ${selectedDays} Tagen.</div>`;
      } else {
        summaryHtml += `<table class='table table-sm table-bordered'><thead><tr><th>Produkt</th><th>Geschmack</th><th>Menge</th><th>Preis (CHF)</th><th>Löschen</th></tr></thead><tbody>`;
        for (const key in summaryMap) {
          const s = summaryMap[key];
          summaryHtml += `<tr><td>${s.produkt}</td><td>${s.geschmack}</td><td>${s.menge}</td><td>${Number(s.preis).toFixed(2)}</td><td><button class='btn btn-sm btn-danger' onclick='deleteWeeklyOrder("${s.produkt}","${s.geschmack}",${s.preis})'>Löschen</button></td></tr>`;
          weeklySummaryData.push([s.produkt, s.geschmack, s.menge, Number(s.preis).toFixed(2)]);
        }
        summaryHtml += `</tbody></table>`;
      }
    // Löschen-Funktion für wöchentliche Zusammenfassung
    window.deleteWeeklyOrder = async function(produkt, geschmack, preis) {
      if (!confirm('Alle Bestellungen dieses Produkts/Geschmacks wirklich löschen?')) return;
      const { error } = await supabaseClient.from('bestellungen').delete().eq('produkte', JSON.stringify([{produkt, geschmack, preis}]))
      if (error) alert('Fehler beim Löschen!');
      else loadOrders();
    }
      document.getElementById('weeklySummary').innerHTML = summaryHtml;
    document.getElementById('exportSummaryExcel').onclick = function() {
      const selectedDaysForExport = Number(document.getElementById('summaryDays')?.value || 7);
      if (!weeklySummaryData.length) return alert(`Keine Bestellungen in den letzten ${selectedDaysForExport} Tagen.`);
      const wsData = [
        ['Produkt', 'Geschmack', 'Menge', 'Preis (CHF)'],
        ...weeklySummaryData
      ];
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, 'Zusammenfassung');
      XLSX.writeFile(wb, 'woechentliche-zusammenfassung.xlsx');
    };
    // re-generate summary when timeframe changes
    document.getElementById('summaryDays').addEventListener('change', function() {
      loadOrders();
    });
    }

    window.deleteOrder = async function(id) {
      if (!confirm('Bestellung wirklich löschen?')) return;
      const { error } = await supabaseClient.from('bestellungen').delete().eq('id', id);
      if (error) alert('Fehler beim Löschen!');
      else loadOrders();
    }

    // Passwortabfrage
    document.getElementById('pwBtn').onclick = function() {
      const pw = document.getElementById('pwInput').value;
      if (pw === 'Coach_Sponser_72') {
        document.getElementById('pwPrompt').style.display = 'none';
        document.getElementById('adminContent').style.display = '';
        // mark admin session for admin tools (checked by admin-sort tool)
        try { sessionStorage.setItem('isAdmin', '1'); } catch(e) {}
        loadOrders();
      } else {
        document.getElementById('pwError').style.display = '';
      }
    };
    document.getElementById('pwInput').addEventListener('keydown', function(e){
      if(e.key==='Enter') document.getElementById('pwBtn').click();
    });

    document.getElementById('exportExcel').onclick = function() {
      const wsData = [
        ['ID', 'Name', 'Produkte', 'Total (CHF)', 'Datum']
      ];
      for (const order of ordersData) {
        let produkte = '';
        try {
          const arr = typeof order.produkte === 'string' ? JSON.parse(order.produkte) : order.produkte;
          // put each product on its own line in the cell
          produkte = arr.map(p => `${p.produkt} (${p.geschmack}) x${p.menge} – CHF ${Number(p.preis).toFixed(2)}`).join('\n');
          var orderTotal = arr.reduce((s, p) => s + Number(p.preis) * Number(p.menge), 0);
        } catch(e) {
          produkte = order.produkte;
          var orderTotal = '';
        }
        wsData.push([
          order.id,
          order.name,
          produkte,
          orderTotal ? Number(orderTotal).toFixed(2) : '',
          new Date(order.timestamp).toLocaleString()
        ]);
      }
      const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  // set a reasonable column width and enable wrap for the products cell where we use newlines
  ws['!cols'] = [{ wch: 6 }, { wch: 20 }, { wch: 60 }, { wch: 12 }, { wch: 20 }];
      // Adjust row heights for cells that contain newlines so multiline content is visible
      const rows = [];
      for (let r = 1; r <= ordersData.length; r++) {
        const cellAddr = XLSX.utils.encode_cell({ c: 2, r }); // column C (index 2)
        let height = null;
        if (ws[cellAddr] && typeof ws[cellAddr].v === 'string' && ws[cellAddr].v.indexOf('\n') !== -1) {
          const lines = ws[cellAddr].v.split('\n').length;
          // approx row height: base 18 + 7 per extra line
          height = Math.min(18 + (lines - 1) * 10, 120);
        }
        rows[r] = height ? { hpt: height } : undefined;
      }
      if (rows.length) ws['!rows'] = rows;
      // attempt to format the Total column as number (Excel may still need manual format depending on client)
      for (let r = 1; r <= ordersData.length; r++) {
        const totalCellAddr = XLSX.utils.encode_cell({ c: 3, r }); // column D (index 3) for total
        if (ws[totalCellAddr] && ws[totalCellAddr].v !== '') {
          // ensure numeric type
          ws[totalCellAddr].t = 'n';
          ws[totalCellAddr].v = Number(ws[totalCellAddr].v);
        }
      }
      XLSX.utils.book_append_sheet(wb, ws, 'Bestellungen');
      XLSX.writeFile(wb, 'bestellungen.xlsx');
    };

    document.getElementById('exportPDF').onclick = async function() {
      if (!ordersData || ordersData.length === 0) {
        alert('Keine Bestellungen zum Export vorhanden!');
        return;
      }

      // open admin-sort (expects built app at /admin-sort/)

      // Button-Handler für 'Artikel sortieren' ganz am Ende setzen
      window.addEventListener('DOMContentLoaded', function() {
        var sortBtn = document.getElementById('openSort');
        if (sortBtn) {
          sortBtn.onclick = function() {
            window.location.href = '/admin-sort/';
          };
        } else {
          console.error('Button "Artikel sortieren" (openSort) nicht gefunden!');
        }
      });
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
      // Beide Logos einfügen
      const ehcbLogoUrl = '/assets/Logo_EHCB.png';
      const sponserLogoUrl = '/assets/Sponser_Logo.png';
      let ehcbImgData = null;
      let sponserImgData = null;
      
      // EHCB Logo laden
      try {
        const response = await fetch(ehcbLogoUrl);
        const blob = await response.blob();
        const reader = new FileReader();
        ehcbImgData = await new Promise(resolve => {
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(blob);
        });
      } catch(e) {}
      
      // Sponser Logo laden
      try {
        const response = await fetch(sponserLogoUrl);
        const blob = await response.blob();
        const reader = new FileReader();
        sponserImgData = await new Promise(resolve => {
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(blob);
        });
      } catch(e) {}
      
      const pageWidth = 297;
      const maxLogoHeight = 30; // maximal 30mm hoch
      const logoGap = 10; // Abstand zwischen den Logos
      const logoY = 8;
      let logosLoaded = false;
      
      if (ehcbImgData && sponserImgData) {
        logosLoaded = true;
        // Beide Logos laden und Größe berechnen
        const ehcbImg = new Image();
        ehcbImg.src = ehcbImgData;
        await new Promise(resolve => { ehcbImg.onload = resolve; });
        
        const sponserImg = new Image();
        sponserImg.src = sponserImgData;
        await new Promise(resolve => { sponserImg.onload = resolve; });
        
        // EHCB Logo Größe berechnen
        let ehcbLogoHeight = maxLogoHeight;
        let ehcbLogoWidth = (ehcbImg.width / ehcbImg.height) * ehcbLogoHeight;
        if (ehcbLogoHeight > maxLogoHeight) {
          ehcbLogoHeight = maxLogoHeight;
          ehcbLogoWidth = (ehcbImg.width / ehcbImg.height) * ehcbLogoHeight;
        }
        
        // Sponser Logo kleiner machen (70% der EHCB Logo Höhe)
        let sponserLogoHeight = ehcbLogoHeight * 0.7;
        let sponserLogoWidth = (sponserImg.width / sponserImg.height) * sponserLogoHeight;
        
        // Beide Logos zentriert untereinander platzieren
        const ehcbX = (pageWidth - ehcbLogoWidth) / 2;
        const sponserX = (pageWidth - sponserLogoWidth) / 2;
        const sponserY = logoY + ehcbLogoHeight + logoGap;
        
        doc.addImage(ehcbImgData, 'PNG', ehcbX, logoY, ehcbLogoWidth, ehcbLogoHeight);
        doc.addImage(sponserImgData, 'PNG', sponserX, sponserY, sponserLogoWidth, sponserLogoHeight);
        
        // Titel unterhalb der Logos
        const totalLogoHeight = ehcbLogoHeight + logoGap + sponserLogoHeight;
        var titleY = logoY + totalLogoHeight + 17;
      } else {
        var titleY = 45;
      }
      // Empfängeradresse oben links
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      const addrY = 13;
      doc.text('Empfänger:', 10, addrY);
      doc.setFont('helvetica', 'normal');
      doc.text('EHC Biel Sport AG', 10, addrY + 5);
      doc.text('Noël Guyaz', 10, addrY + 10);
      doc.text('Boulevard des Sports 18', 10, addrY + 15);
      doc.text('2504 Biel', 10, addrY + 20);
      doc.text('Schweiz', 10, addrY + 25);
      doc.setFontSize(16);
      doc.text('Bestellübersicht', 297/2, titleY, {align:'center'});
  doc.setFontSize(11);
  let startY = titleY + 10;
  // Tabellenkopf
  doc.setFont('helvetica', 'bold');
  doc.text('ID', 10, startY);
  doc.text('Name', 30, startY);
  doc.text('Produkte', 70, startY);
  doc.text('Total (CHF)', 230, startY);
  doc.text('Datum', 260, startY);
  doc.setFont('helvetica', 'normal');
  startY += 8;
      for (const order of ordersData) {
        let produkte = '';
        try {
          const arr = typeof order.produkte === 'string' ? JSON.parse(order.produkte) : order.produkte;
          produkte = arr.map(p => `${p.produkt} (${p.geschmack}) x${p.menge} – CHF ${Number(p.preis).toFixed(2)}`);
        } catch(e) {
          produkte = [order.produkte];
        }
        // compute order total so we can print it in the PDF
        let orderTotal = '';
        try {
          const arrTot = typeof order.produkte === 'string' ? JSON.parse(order.produkte) : order.produkte;
          orderTotal = arrTot.reduce((s, p) => s + Number(p.preis) * Number(p.menge), 0);
        } catch (e) {
          orderTotal = '';
        }
  doc.text(String(order.id), 10, startY);
  doc.text(String(order.name), 30, startY);
        // print products on multiple lines within the same table cell
        const prodX = 70;
        const prodMaxWidth = 170;
        let prodY = startY;
        for (const ptext of produkte) {
          const split = doc.splitTextToSize(String(ptext), prodMaxWidth);
          doc.text(split, prodX, prodY);
          prodY += 6 * split.length;
        }
        // ensure timestamp is vertically aligned with the first product line
        doc.text(new Date(order.timestamp).toLocaleString(), 260, startY);
        // print total value next to products
        if (orderTotal) {
          doc.text(String(Number(orderTotal).toFixed(2)), 230, startY);
        }
        // move startY to after the tallest cell (products area)
        startY = Math.max(prodY, startY + 8);
        if (startY > 190) { 
          doc.addPage(); 
          if (logosLoaded && ehcbImgData && sponserImgData) {
            const ehcbImg = new Image();
            ehcbImg.src = ehcbImgData;
            await new Promise(resolve => { ehcbImg.onload = resolve; });
            const sponserImg = new Image();
            sponserImg.src = sponserImgData;
            await new Promise(resolve => { sponserImg.onload = resolve; });
            const smallEhcbHeight = 18;
            const ehcbSmallWidth = (ehcbImg.width / ehcbImg.height) * smallEhcbHeight;
            const smallSponserHeight = smallEhcbHeight * 0.7;
            const sponserSmallWidth = (sponserImg.width / sponserImg.height) * smallSponserHeight;
            const ehcbSmallX = (297 - ehcbSmallWidth) / 2;
            const sponserSmallX = (297 - sponserSmallWidth) / 2;
            const sponserSmallY = 8 + smallEhcbHeight + 5;
            doc.addImage(ehcbImgData, 'PNG', ehcbSmallX, 8, ehcbSmallWidth, smallEhcbHeight);
            doc.addImage(sponserImgData, 'PNG', sponserSmallX, sponserSmallY, sponserSmallWidth, smallSponserHeight);
          }
          // Empfängeradresse auch auf weiteren Seiten
          doc.setFontSize(10);
          doc.setFont('helvetica', 'bold');
          doc.text('Empfänger:', 10, 13);
          doc.setFont('helvetica', 'normal');
          doc.text('EHC Biel Sport AG', 10, 18);
          doc.text('Noël Guyaz', 10, 23);
          doc.text('Boulevard des Sports 18', 10, 28);
          doc.text('2504 Biel', 10, 33);
          doc.text('Schweiz', 10, 38);
          startY = 48; 
          doc.setFont('helvetica', 'bold');
          doc.text('ID', 10, startY);
          doc.text('Name', 30, startY);
          doc.text('Produkte', 70, startY);
          doc.text('Total (CHF)', 230, startY);
          doc.text('Datum', 260, startY);
          doc.setFont('helvetica', 'normal');
          startY += 10;
        }
      }
      doc.save('bestellungen.pdf');
    };
  </script>
</body>
</html>
