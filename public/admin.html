<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin – Bestellübersicht</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex align-items-center mb-4">
      <img src="/assets/logo.png" alt="EHCB Sponser Logo" style="height:60px;margin-right:20px;">
      <h2 class="mb-0">Bestellübersicht</h2>
    </div>
    <div class="mb-3 d-flex gap-2">
      <a href="/index.html" class="btn btn-secondary">Zurück zum Shop</a>
      <button id="exportExcel" class="btn btn-success">Export als Excel</button>
      <button id="exportPDF" class="btn btn-danger">Export als PDF</button>
    </div>
    <div id="ordersTable"></div>
  </div>
  <script>
    const supabaseUrl = 'https://sqlnoaaimkrxrkspqtbq.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxbG5vYWFpbWtyeHJrc3BxdGJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzgyMzAsImV4cCI6MjA3MTI1NDIzMH0.oI201Oqgc2M3ckXePjZAHty1hXVC8M8qptjz8r9QUG4';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    let ordersData = [];
    async function loadOrders() {
      const { data, error } = await supabase
        .from('bestellungen')
        .select('*')
        .order('timestamp', { ascending: false });
      if (error) {
        document.getElementById('ordersTable').innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Bestellungen!</div>';
        return;
      }
      ordersData = data;
      let html = `<table class="table table-bordered table-striped"><thead><tr><th>ID</th><th>Name</th><th>Produkte</th><th>Datum</th></tr></thead><tbody>`;
      for (const order of data) {
        let produkte = '';
        try {
          const arr = typeof order.produkte === 'string' ? JSON.parse(order.produkte) : order.produkte;
          produkte = arr.map(p => `${p.produkt} (${p.geschmack}) x${p.menge} – CHF ${Number(p.preis).toFixed(2)}`).join('; ');
        } catch(e) {
          produkte = order.produkte;
        }
        html += `<tr><td>${order.id}</td><td>${order.name}</td><td>${produkte}</td><td>${new Date(order.timestamp).toLocaleString()}</td></tr>`;
      }
      html += '</tbody></table>';
      document.getElementById('ordersTable').innerHTML = html;
    }
    loadOrders();

    document.getElementById('exportExcel').onclick = function() {
      const wsData = [
        ['ID', 'Name', 'Produkte', 'Datum']
      ];
      for (const order of ordersData) {
        let produkte = '';
        try {
          const arr = typeof order.produkte === 'string' ? JSON.parse(order.produkte) : order.produkte;
          produkte = arr.map(p => `${p.produkt} (${p.geschmack}) x${p.menge} – CHF ${Number(p.preis).toFixed(2)}`).join('; ');
        } catch(e) {
          produkte = order.produkte;
        }
        wsData.push([
          order.id,
          order.name,
          produkte,
          new Date(order.timestamp).toLocaleString()
        ]);
      }
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, 'Bestellungen');
      XLSX.writeFile(wb, 'bestellungen.xlsx');
    };

    document.getElementById('exportPDF').onclick = function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(12);
      doc.text('Bestellübersicht', 14, 16);
      let startY = 24;
      doc.setFont('helvetica', 'bold');
      doc.text('ID', 14, startY);
      doc.text('Name', 34, startY);
      doc.text('Produkte', 74, startY);
      doc.text('Datum', 164, startY);
      doc.setFont('helvetica', 'normal');
      startY += 8;
      for (const order of ordersData) {
        let produkte = '';
        try {
          const arr = typeof order.produkte === 'string' ? JSON.parse(order.produkte) : order.produkte;
          produkte = arr.map(p => `${p.produkt} (${p.geschmack}) x${p.menge} – CHF ${Number(p.preis).toFixed(2)}`).join('; ');
        } catch(e) {
          produkte = order.produkte;
        }
        doc.text(String(order.id), 14, startY);
        doc.text(String(order.name), 34, startY);
        doc.text(produkte, 74, startY, { maxWidth: 85 });
        doc.text(new Date(order.timestamp).toLocaleString(), 164, startY);
        startY += 8;
        if (startY > 280) { doc.addPage(); startY = 24; }
      }
      doc.save('bestellungen.pdf');
    };
  </script>
</body>
</html>
