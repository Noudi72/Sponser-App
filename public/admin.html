<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin – Bestellübersicht</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div id="pwPrompt" style="max-width:400px;margin:60px auto;text-align:center;">
      <img src="/assets/logo.png" alt="EHCB Sponser Logo" style="height:60px;margin-bottom:20px;">
      <h2 class="mb-3">Admin Login</h2>
      <input type="password" id="pwInput" class="form-control mb-2" placeholder="Passwort">
      <button id="pwBtn" class="btn btn-primary">Login</button>
      <div id="pwError" class="text-danger mt-2" style="display:none;">Falsches Passwort!</div>
    </div>
    <div id="adminContent" style="display:none;">
      <div class="d-flex align-items-center mb-4">
        <img src="/assets/logo.png" alt="EHCB Sponser Logo" style="height:60px;margin-right:20px;">
        <h2 class="mb-0">Bestellübersicht</h2>
      </div>
      <div class="mb-3 d-flex gap-2">
        <a href="/index.html" class="btn btn-secondary">Zurück zum Shop</a>
        <button id="exportExcel" class="btn btn-success">Export als Excel</button>
        <button id="exportPDF" class="btn btn-danger">Export als PDF</button>
      </div>
      <div id="ordersTable"></div>
  <div id="weeklySummary" class="mt-4"></div>
    </div>
  </div>
  <script>
    const supabaseUrl = 'https://sqlnoaaimkrxrkspqtbq.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxbG5vYWFpbWtyeHJrc3BxdGJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzgyMzAsImV4cCI6MjA3MTI1NDIzMH0.oI201Oqgc2M3ckXePjZAHty1hXVC8M8qptjz8r9QUG4';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    let ordersData = [];
    async function loadOrders() {
      const { data, error } = await supabase
        .from('bestellungen')
        .select('*')
        .order('timestamp', { ascending: false });
      if (error) {
        document.getElementById('ordersTable').innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Bestellungen!</div>';
        return;
      }
      ordersData = data;
      let html = `<table class="table table-bordered table-striped"><thead><tr><th>ID</th><th>Name</th><th>Produkte</th><th>Datum</th><th>Löschen</th></tr></thead><tbody>`;
      for (const order of data) {
        let produkte = '';
        try {
          const arr = typeof order.produkte === 'string' ? JSON.parse(order.produkte) : order.produkte;
          produkte = arr.map(p => `${p.produkt} (${p.geschmack}) x${p.menge} – CHF ${Number(p.preis).toFixed(2)}`).join('; ');
        } catch(e) {
          produkte = order.produkte;
        }
        html += `<tr><td>${order.id}</td><td>${order.name}</td><td>${produkte}</td><td>${new Date(order.timestamp).toLocaleString()}</td><td><button class='btn btn-sm btn-danger' onclick='deleteOrder(${order.id})'>Löschen</button></td></tr>`;
      }
      html += '</tbody></table>';
      document.getElementById('ordersTable').innerHTML = html;

      // Wöchentliche Zusammenfassung
      const oneWeekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
      const weeklyOrders = data.filter(order => new Date(order.timestamp).getTime() >= oneWeekAgo);
      const summaryMap = {};
      for (const order of weeklyOrders) {
        let arr = [];
        try {
          arr = typeof order.produkte === 'string' ? JSON.parse(order.produkte) : order.produkte;
        } catch(e) {
          arr = [];
        }
        for (const p of arr) {
          const key = `${p.produkt}|${p.geschmack}|${p.preis}`;
          if (!summaryMap[key]) {
            summaryMap[key] = { produkt: p.produkt, geschmack: p.geschmack, preis: p.preis, menge: 0 };
          }
          summaryMap[key].menge += Number(p.menge);
        }
      }
      let summaryHtml = `<h4>Wöchentliche Zusammenfassung</h4>`;
      if (Object.keys(summaryMap).length === 0) {
        summaryHtml += `<div class='text-muted'>Keine Bestellungen in den letzten 7 Tagen.</div>`;
      } else {
        summaryHtml += `<table class='table table-sm table-bordered'><thead><tr><th>Produkt</th><th>Geschmack</th><th>Menge</th><th>Preis (CHF)</th></tr></thead><tbody>`;
        for (const key in summaryMap) {
          const s = summaryMap[key];
          summaryHtml += `<tr><td>${s.produkt}</td><td>${s.geschmack}</td><td>${s.menge}</td><td>${Number(s.preis).toFixed(2)}</td></tr>`;
        }
        summaryHtml += `</tbody></table>`;
      }
      document.getElementById('weeklySummary').innerHTML = summaryHtml;
    }

    window.deleteOrder = async function(id) {
      if (!confirm('Bestellung wirklich löschen?')) return;
      const { error } = await supabase.from('bestellungen').delete().eq('id', id);
      if (error) alert('Fehler beim Löschen!');
      else loadOrders();
    }

    // Passwortabfrage
    document.getElementById('pwBtn').onclick = function() {
      const pw = document.getElementById('pwInput').value;
      if (pw === 'Coach_Sponser_72') {
        document.getElementById('pwPrompt').style.display = 'none';
        document.getElementById('adminContent').style.display = '';
        loadOrders();
      } else {
        document.getElementById('pwError').style.display = '';
      }
    };
    document.getElementById('pwInput').addEventListener('keydown', function(e){
      if(e.key==='Enter') document.getElementById('pwBtn').click();
    });

    document.getElementById('exportExcel').onclick = function() {
      const wsData = [
        ['ID', 'Name', 'Produkte', 'Datum']
      ];
      for (const order of ordersData) {
        let produkte = '';
        try {
          const arr = typeof order.produkte === 'string' ? JSON.parse(order.produkte) : order.produkte;
          produkte = arr.map(p => `${p.produkt} (${p.geschmack}) x${p.menge} – CHF ${Number(p.preis).toFixed(2)}`).join('; ');
        } catch(e) {
          produkte = order.produkte;
        }
        wsData.push([
          order.id,
          order.name,
          produkte,
          new Date(order.timestamp).toLocaleString()
        ]);
      }
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, 'Bestellungen');
      XLSX.writeFile(wb, 'bestellungen.xlsx');
    };

    document.getElementById('exportPDF').onclick = async function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
      // Logo einfügen
      const logoUrl = '/assets/logo.png';
      let imgData = null;
      try {
        const response = await fetch(logoUrl);
        const blob = await response.blob();
        const reader = new FileReader();
        imgData = await new Promise(resolve => {
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(blob);
        });
      } catch(e) {}
      if (imgData) doc.addImage(imgData, 'PNG', 10, 8, 40, 18);
      doc.setFontSize(16);
      doc.text('Bestellübersicht', 55, 20);
      doc.setFontSize(11);
      let startY = 32;
      // Tabellenkopf
      doc.setFont('helvetica', 'bold');
      doc.text('ID', 10, startY);
      doc.text('Name', 30, startY);
      doc.text('Produkte', 70, startY);
      doc.text('Datum', 250, startY);
      doc.setFont('helvetica', 'normal');
      startY += 8;
      for (const order of ordersData) {
        let produkte = '';
        try {
          const arr = typeof order.produkte === 'string' ? JSON.parse(order.produkte) : order.produkte;
          produkte = arr.map(p => `${p.produkt} (${p.geschmack}) x${p.menge} – CHF ${Number(p.preis).toFixed(2)}`).join('; ');
        } catch(e) {
          produkte = order.produkte;
        }
        doc.text(String(order.id), 10, startY);
        doc.text(String(order.name), 30, startY);
        doc.text(produkte, 70, startY, { maxWidth: 170 });
        doc.text(new Date(order.timestamp).toLocaleString(), 250, startY);
        startY += 8;
        if (startY > 190) { doc.addPage(); if (imgData) doc.addImage(imgData, 'PNG', 10, 8, 40, 18); startY = 32; }
      }
      doc.save('bestellungen.pdf');
    };
  </script>
</body>
</html>
