<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin – Bestellübersicht</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex align-items-center mb-4">
      <img src="/assets/logo.png" alt="EHCB Sponser Logo" style="height:60px;margin-right:20px;">
      <h2 class="mb-0">Bestellübersicht</h2>
    </div>
    <div class="mb-3">
      <a href="/index.html" class="btn btn-secondary">Zurück zum Shop</a>
    </div>
    <div id="ordersTable"></div>
  </div>
  <script>
    const supabaseUrl = 'https://sqlnoaaimkrxrkspqtbq.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxbG5vYWFpbWtyeHJrc3BxdGJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzgyMzAsImV4cCI6MjA3MTI1NDIzMH0.oI201Oqgc2M3ckXePjZAHty1hXVC8M8qptjz8r9QUG4';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    async function loadOrders() {
      const { data, error } = await supabase
        .from('bestellungen')
        .select('*')
        .order('timestamp', { ascending: false });
      if (error) {
        document.getElementById('ordersTable').innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Bestellungen!</div>';
        return;
      }
      let html = `<table class="table table-bordered table-striped"><thead><tr><th>ID</th><th>Produkte</th><th>Datum</th></tr></thead><tbody>`;
      for (const order of data) {
        let produkte = '';
        try {
          const arr = typeof order.produkte === 'string' ? JSON.parse(order.produkte) : order.produkte;
          produkte = arr.map(p => `<div><b>${p.produkt}</b> (${p.geschmack}) x${p.menge} – CHF ${p.preis}</div>`).join('');
        } catch(e) {
          produkte = order.produkte;
        }
        html += `<tr><td>${order.id}</td><td>${produkte}</td><td>${new Date(order.timestamp).toLocaleString()}</td></tr>`;
      }
      html += '</tbody></table>';
      document.getElementById('ordersTable').innerHTML = html;
    }
    loadOrders();
  </script>
</body>
</html>
