<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin – Bestellübersicht</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div id="pwPrompt" style="max-width:400px;margin:60px auto;text-align:center;">
      <img src="/assets/logo.png" alt="EHCB Sponser Logo" style="height:60px;margin-bottom:20px;">
      <h2 class="mb-3">Admin Login</h2>
      <input type="password" id="pwInput" class="form-control mb-2" placeholder="Passwort">
      <button id="pwBtn" class="btn btn-primary">Login</button>
      <div id="pwError" class="text-danger mt-2" style="display:none;">Falsches Passwort!</div>
    </div>
    <div id="adminContent" style="display:none;">
      <div class="d-flex align-items-center mb-4">
        <img src="/assets/logo.png" alt="EHCB Sponser Logo" style="height:60px;margin-right:20px;">
        <h2 class="mb-0">Bestellübersicht</h2>
      </div>
      <div class="mb-3 d-flex gap-2">
        <a href="/index.html" class="btn btn-secondary">Zurück zum Shop</a>
        <button id="exportExcel" class="btn btn-success">Export als Excel</button>
        <button id="exportPDF" class="btn btn-danger">Export als PDF</button>
  <a href="/admin-sort/" class="btn btn-info text-white" id="openSort">Artikel sortieren</a>
      </div>
      <div id="ordersTable"></div>
      <div class="d-flex align-items-center gap-3 mt-4">
        <div>
          <label class="form-label mb-1">Zeitraum Zusammenfassung:</label>
          <div class="d-flex gap-2">
            <select id="summaryDays" class="form-select form-select-sm" style="max-width:140px;">
              <option value="7">Letzte 7 Tage</option>
              <option value="14">Letzte 14 Tage</option>
              <option value="21">Letzte 21 Tage</option>
              <option value="31">Letzte 31 Tage</option>
            </select>
            <input type="date" id="summaryFrom" class="form-control form-control-sm" title="Von (Datum)" />
            <input type="date" id="summaryTo" class="form-control form-control-sm" title="Bis (Datum)" />
          </div>
          <small class="text-muted">Optional: Wähle ein benutzerdefiniertes Von/Bis-Datum. Leerlassen = Auswahl oben (letzte X Tage).</small>
        </div>
        <div class="ms-auto text-end">
          <small class="text-muted">Wähle Zeitraum für die Zusammenfassung und Exporte</small>
        </div>
      </div>
      <div id="weeklySummary" class="mt-3"></div>
      <div class="mb-3">
  <button id="exportSummaryExcel" class="btn btn-success btn-sm">Zusammenfassung als Excel exportieren</button>
  <button id="exportSummaryPDF" class="btn btn-danger btn-sm ms-2">Zusammenfassung als PDF exportieren</button>
      </div>
    <div class="mb-2"><small class="text-muted">Hinweis: Wenn Excel Produkte nicht untereinander anzeigt, markiere die Spalte und aktiviere 'Wrap Text' (Zellen formatieren → Alignment → Wrap text).</small></div>
    </div>
  </div>
  <script>
    document.getElementById('exportSummaryPDF').onclick = async function() {
      const range = getSummaryRange();
      if (!weeklySummaryData.length) return alert(`Keine Bestellungen im Zeitraum ${range.label}.`);
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
      // Logo einfügen
      const logoUrl = '/assets/logo.png';
      let imgData = null;
      try {
        const response = await fetch(logoUrl);
        const blob = await response.blob();
        const reader = new FileReader();
        imgData = await new Promise(resolve => {
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(blob);
        });
      } catch(e) {}
      if (imgData) {
        // Seitenbreite: 297mm (A4 landscape), Logo soll zentriert und proportional sein
        const pageWidth = 297;
        const maxLogoWidth = 80; // maximal 80mm breit
        const maxLogoHeight = 36; // maximal 36mm hoch
        const img = new Image();
        img.src = imgData;
        await new Promise(resolve => { img.onload = resolve; });
        let logoWidth = maxLogoWidth;
        let logoHeight = img.height / img.width * logoWidth;
        if (logoHeight > maxLogoHeight) {
          logoHeight = maxLogoHeight;
          logoWidth = img.width / img.height * logoHeight;
        }
        const logoX = (pageWidth - logoWidth) / 2;
        // place logo a bit lower to leave space for title
        const logoY = 10;
        doc.addImage(imgData, 'PNG', logoX, logoY, logoWidth, logoHeight);
        // title below logo
        doc.setFontSize(16);
        const titleY = logoY + logoHeight + 6;
  doc.text('Bestellung EHC Biel-Bienne Spirit', pageWidth / 2, titleY, {align: 'center'});
        doc.setFontSize(11);
        var startY = titleY + 10;
      } else {
        doc.setFontSize(16);
  doc.text('Bestellung EHC Biel-Bienne Spirit', 297/2, 18, {align:'center'});
        doc.setFontSize(11);
        var startY = 32;
      }
  // Tabellenkopf
  doc.setFont('helvetica', 'bold');
  doc.text('Produkt', 10, startY);
  doc.text('Geschmack', 70, startY);
  doc.text('Menge', 130, startY);
  doc.text('Preis (CHF)', 170, startY);
  doc.setFont('helvetica', 'normal');
  startY += 10;
      for (const row of weeklySummaryData) {
        doc.text(String(row[0]), 10, startY);
        doc.text(String(row[1]), 70, startY);
        doc.text(String(row[2]), 130, startY);
        doc.text(String(row[3]), 170, startY);
        startY += 8;
        if (startY > 190) { doc.addPage(); if (imgData) doc.addImage(imgData, 'PNG', 10, 8, 40, 18); startY = 32; }
      }
      doc.save('woechentliche-zusammenfassung.pdf');
    };
  let weeklySummaryData = [];

  function getSummaryRange() {
    const fromVal = document.getElementById('summaryFrom')?.value;
    const toVal = document.getElementById('summaryTo')?.value;
    if (fromVal || toVal) {
      const from = fromVal ? new Date(fromVal).setHours(0,0,0,0) : 0;
      const to = toVal ? new Date(toVal).setHours(23,59,59,999) : Date.now();
      const label = `${fromVal ? fromVal : '...'} - ${toVal ? toVal : '...'} `;
      return { from, to, label };
    }
    const selectedDays = Number(document.getElementById('summaryDays')?.value || 7);
    const to = Date.now();
    const from = to - selectedDays * 24 * 60 * 60 * 1000;
    return { from, to, label: `letzte ${selectedDays} Tage` };
  }
    const supabaseUrl = 'https://sqlnoaaimkrxrkspqtbq.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxbG5vYWFpbWtyeHJrc3BxdGJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzgyMzAsImV4cCI6MjA3MTI1NDIzMH0.oI201Oqgc2M3ckXePjZAHty1hXVC8M8qptjz8r9QUG4';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    let ordersData = [];
    async function loadOrders() {
      document.getElementById('exportPDF').disabled = true;
      const { data, error } = await supabase
        .from('bestellungen')
        .select('*')
        .order('timestamp', { ascending: false });
      if (error) {
        document.getElementById('ordersTable').innerHTML = '<div class="alert alert-danger">Fehler beim Laden der Bestellungen!</div>';
        return;
      }
  ordersData = data;
  document.getElementById('exportPDF').disabled = false;
      let html = `<table class="table table-bordered table-striped"><thead><tr><th>ID</th><th>Name</th><th>Produkte</th><th>Total (CHF)</th><th>Datum</th><th>Löschen</th></tr></thead><tbody>`;
      for (const order of data) {
        let produkte = '';
        try {
          const arr = typeof order.produkte === 'string' ? JSON.parse(order.produkte) : order.produkte;
          produkte = arr.map(p => `${p.produkt} (${p.geschmack}) x${p.menge} – CHF ${Number(p.preis).toFixed(2)}`).join('; ');
          // compute total for the order
          const totalSum = arr.reduce((s, p) => s + Number(p.preis) * Number(p.menge), 0);
        } catch(e) {
          produkte = order.produkte;
          const totalSum = 0;
        }
        // if totalSum is not in scope (caught), compute from string fallback
        let displayTotal = '';
        try {
          const arr2 = typeof order.produkte === 'string' ? JSON.parse(order.produkte) : order.produkte;
          const total = arr2.reduce((s, p) => s + Number(p.preis) * Number(p.menge), 0);
          displayTotal = `CHF ${total.toFixed(2)}`;
        } catch(e) {
          displayTotal = '';
        }
        html += `<tr><td>${order.id}</td><td>${order.name}</td><td>${produkte}</td><td>${displayTotal}</td><td>${new Date(order.timestamp).toLocaleString()}</td><td><button class='btn btn-sm btn-danger' onclick='deleteOrder(${order.id})'>Löschen</button></td></tr>`;
      }
      html += '</tbody></table>';
      document.getElementById('ordersTable').innerHTML = html;
      // compute and show total of displayed orders
      try {
        const visibleOrders = data;
        const grandTotal = visibleOrders.reduce((s, o) => {
          try {
            const arr = typeof o.produkte === 'string' ? JSON.parse(o.produkte) : o.produkte;
            return s + arr.reduce((ss, p) => ss + Number(p.preis) * Number(p.menge), 0);
          } catch(e) { return s; }
        }, 0);
        const totalHtml = `<div class="mt-2"><strong>Gesamtsumme (angezeigte Bestellungen):</strong> CHF ${grandTotal.toFixed(2)}</div>`;
        document.getElementById('ordersTable').insertAdjacentHTML('afterend', totalHtml);
      } catch(e) {}

      // Wöchentliche Zusammenfassung
  // determine timeframe from selector or custom from/to
  const range = getSummaryRange();
  const weeklyOrders = data.filter(order => {
    const t = new Date(order.timestamp).getTime();
    return t >= range.from && t <= range.to;
  });
      const summaryMap = {};
      weeklySummaryData = [];
      for (const order of weeklyOrders) {
        let arr = [];
        try {
          arr = typeof order.produkte === 'string' ? JSON.parse(order.produkte) : order.produkte;
        } catch(e) {
          arr = [];
        }
        for (const p of arr) {
          const key = `${p.produkt}|${p.geschmack}|${p.preis}`;
          if (!summaryMap[key]) {
            summaryMap[key] = { produkt: p.produkt, geschmack: p.geschmack, preis: p.preis, menge: 0 };
          }
          summaryMap[key].menge += Number(p.menge);
        }
      }
  let summaryHtml = `<h4>Zusammenfassung (${range.label})</h4>`;
      if (Object.keys(summaryMap).length === 0) {
        summaryHtml += `<div class='text-muted'>Keine Bestellungen in den letzten ${selectedDays} Tagen.</div>`;
      } else {
        summaryHtml += `<table class='table table-sm table-bordered'><thead><tr><th>Produkt</th><th>Geschmack</th><th>Menge</th><th>Preis (CHF)</th><th>Löschen</th></tr></thead><tbody>`;
        for (const key in summaryMap) {
          const s = summaryMap[key];
          summaryHtml += `<tr><td>${s.produkt}</td><td>${s.geschmack}</td><td>${s.menge}</td><td>${Number(s.preis).toFixed(2)}</td><td><button class='btn btn-sm btn-danger' onclick='deleteWeeklyOrder("${s.produkt}","${s.geschmack}",${s.preis})'>Löschen</button></td></tr>`;
          weeklySummaryData.push([s.produkt, s.geschmack, s.menge, Number(s.preis).toFixed(2)]);
        }
        summaryHtml += `</tbody></table>`;
      }
    // Löschen-Funktion für wöchentliche Zusammenfassung
    window.deleteWeeklyOrder = async function(produkt, geschmack, preis) {
      if (!confirm('Alle Bestellungen dieses Produkts/Geschmacks wirklich löschen?')) return;
      const { error } = await supabase.from('bestellungen').delete().eq('produkte', JSON.stringify([{produkt, geschmack, preis}]))
      if (error) alert('Fehler beim Löschen!');
      else loadOrders();
    }
      document.getElementById('weeklySummary').innerHTML = summaryHtml;
    document.getElementById('exportSummaryExcel').onclick = function() {
      const range = getSummaryRange();
      if (!weeklySummaryData.length) return alert(`Keine Bestellungen im Zeitraum ${range.label}.`);
      const wsData = [
        ['Produkt', 'Geschmack', 'Menge', 'Preis (CHF)'],
        ...weeklySummaryData
      ];
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb, ws, 'Zusammenfassung');
      XLSX.writeFile(wb, 'woechentliche-zusammenfassung.xlsx');
    };
    // re-generate summary when timeframe changes or custom dates are set
    document.getElementById('summaryDays').addEventListener('change', function() { loadOrders(); });
    document.getElementById('summaryFrom').addEventListener('change', function() { loadOrders(); });
    document.getElementById('summaryTo').addEventListener('change', function() { loadOrders(); });
    }

    window.deleteOrder = async function(id) {
      if (!confirm('Bestellung wirklich löschen?')) return;
      const { error } = await supabase.from('bestellungen').delete().eq('id', id);
      if (error) alert('Fehler beim Löschen!');
      else loadOrders();
    }

    // Passwortabfrage
    document.getElementById('pwBtn').onclick = function() {
      const pw = document.getElementById('pwInput').value;
      if (pw === 'Coach_Sponser_72') {
        document.getElementById('pwPrompt').style.display = 'none';
        document.getElementById('adminContent').style.display = '';
        // mark admin session for admin tools (checked by admin-sort tool)
        try { sessionStorage.setItem('isAdmin', '1'); } catch(e) {}
        loadOrders();
      } else {
        document.getElementById('pwError').style.display = '';
      }
    };
    document.getElementById('pwInput').addEventListener('keydown', function(e){
      if(e.key==='Enter') document.getElementById('pwBtn').click();
    });

    document.getElementById('exportExcel').onclick = function() {
      const wsData = [
        ['ID', 'Name', 'Produkte', 'Total (CHF)', 'Datum']
      ];
      for (const order of ordersData) {
        let produkte = '';
        try {
          const arr = typeof order.produkte === 'string' ? JSON.parse(order.produkte) : order.produkte;
          // put each product on its own line in the cell
          produkte = arr.map(p => `${p.produkt} (${p.geschmack}) x${p.menge} – CHF ${Number(p.preis).toFixed(2)}`).join('\n');
          var orderTotal = arr.reduce((s, p) => s + Number(p.preis) * Number(p.menge), 0);
        } catch(e) {
          produkte = order.produkte;
          var orderTotal = '';
        }
        wsData.push([
          order.id,
          order.name,
          produkte,
          orderTotal ? Number(orderTotal).toFixed(2) : '',
          new Date(order.timestamp).toLocaleString()
        ]);
      }
      const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(wsData);
  // set a reasonable column width and enable wrap for the products cell where we use newlines
  ws['!cols'] = [{ wch: 6 }, { wch: 20 }, { wch: 60 }, { wch: 12 }, { wch: 20 }];
      // Adjust row heights for cells that contain newlines so multiline content is visible
      const rows = [];
      for (let r = 1; r <= ordersData.length; r++) {
        const cellAddr = XLSX.utils.encode_cell({ c: 2, r }); // column C (index 2)
        let height = null;
        if (ws[cellAddr] && typeof ws[cellAddr].v === 'string' && ws[cellAddr].v.indexOf('\n') !== -1) {
          const lines = ws[cellAddr].v.split('\n').length;
          // approx row height: base 18 + 7 per extra line
          height = Math.min(18 + (lines - 1) * 10, 120);
        }
        rows[r] = height ? { hpt: height } : undefined;
      }
      if (rows.length) ws['!rows'] = rows;
      // attempt to format the Total column as number (Excel may still need manual format depending on client)
      for (let r = 1; r <= ordersData.length; r++) {
        const totalCellAddr = XLSX.utils.encode_cell({ c: 3, r }); // column D (index 3) for total
        if (ws[totalCellAddr] && ws[totalCellAddr].v !== '') {
          // ensure numeric type
          ws[totalCellAddr].t = 'n';
          ws[totalCellAddr].v = Number(ws[totalCellAddr].v);
        }
      }
      XLSX.utils.book_append_sheet(wb, ws, 'Bestellungen');
      XLSX.writeFile(wb, 'bestellungen.xlsx');
    };

    document.getElementById('exportPDF').onclick = async function() {
      if (!ordersData || ordersData.length === 0) {
        alert('Keine Bestellungen zum Export vorhanden!');
        return;
      }

      // open admin-sort (expects built app at /admin-sort/)

      // Button-Handler für 'Artikel sortieren' ganz am Ende setzen
      window.addEventListener('DOMContentLoaded', function() {
        var sortBtn = document.getElementById('openSort');
        if (sortBtn) {
          sortBtn.onclick = function() {
            window.location.href = '/admin-sort/';
          };
        } else {
          console.error('Button "Artikel sortieren" (openSort) nicht gefunden!');
        }
      });
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
      // Logo schön einfügen: mittig, ca. 80px breit, Höhe automatisch
      const logoUrl = '/assets/logo.png';
      let imgData = null;
      try {
        const response = await fetch(logoUrl);
        const blob = await response.blob();
        const reader = new FileReader();
        imgData = await new Promise(resolve => {
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(blob);
        });
      } catch(e) {}
      if (imgData) {
        // Seitenbreite: 297mm (A4 landscape), Logo soll zentriert und proportional sein
        const pageWidth = 297;
        const maxLogoWidth = 80; // maximal 80mm breit
        const maxLogoHeight = 36; // maximal 36mm hoch
        // Bild laden, um echtes Seitenverhältnis zu bekommen
        const img = new Image();
        img.src = imgData;
        await new Promise(resolve => { img.onload = resolve; });
        let logoWidth = maxLogoWidth;
        let logoHeight = img.height / img.width * logoWidth;
        if (logoHeight > maxLogoHeight) {
          logoHeight = maxLogoHeight;
          logoWidth = img.width / img.height * logoHeight;
        }
        const logoX = (pageWidth - logoWidth) / 2;
        doc.addImage(imgData, 'PNG', logoX, 8, logoWidth, logoHeight);
      }
      doc.setFontSize(16);
      doc.text('Bestellübersicht', 297/2, 20 + 36, {align:'center'});
  doc.setFontSize(11);
  let startY = 32 + 36;
  // Tabellenkopf
  doc.setFont('helvetica', 'bold');
  doc.text('ID', 10, startY);
  doc.text('Name', 30, startY);
  doc.text('Produkte', 70, startY);
  doc.text('Total (CHF)', 230, startY);
  doc.text('Datum', 260, startY);
  doc.setFont('helvetica', 'normal');
  startY += 8;
      for (const order of ordersData) {
        let produkte = '';
        try {
          const arr = typeof order.produkte === 'string' ? JSON.parse(order.produkte) : order.produkte;
          produkte = arr.map(p => `${p.produkt} (${p.geschmack}) x${p.menge} – CHF ${Number(p.preis).toFixed(2)}`);
        } catch(e) {
          produkte = [order.produkte];
        }
        // compute order total so we can print it in the PDF
        let orderTotal = '';
        try {
          const arrTot = typeof order.produkte === 'string' ? JSON.parse(order.produkte) : order.produkte;
          orderTotal = arrTot.reduce((s, p) => s + Number(p.preis) * Number(p.menge), 0);
        } catch (e) {
          orderTotal = '';
        }
  doc.text(String(order.id), 10, startY);
  doc.text(String(order.name), 30, startY);
        // print products on multiple lines within the same table cell
        const prodX = 70;
        const prodMaxWidth = 170;
        let prodY = startY;
        for (const ptext of produkte) {
          const split = doc.splitTextToSize(String(ptext), prodMaxWidth);
          doc.text(split, prodX, prodY);
          prodY += 6 * split.length;
        }
        // ensure timestamp is vertically aligned with the first product line
        doc.text(new Date(order.timestamp).toLocaleString(), 260, startY);
        // print total value next to products
        if (orderTotal) {
          doc.text(String(Number(orderTotal).toFixed(2)), 230, startY);
        }
        // move startY to after the tallest cell (products area)
        startY = Math.max(prodY, startY + 8);
        if (startY > 190) { 
          doc.addPage(); 
          if (imgData) {
            const logoWidth = 80;
            const logoHeight = 36;
            const pageWidth = 297;
            const logoX = (pageWidth - logoWidth) / 2;
            doc.addImage(imgData, 'PNG', logoX, 8, logoWidth, logoHeight);
          }
          startY = 32 + 36; 
          doc.setFont('helvetica', 'bold');
          doc.text('ID', 10, startY);
          doc.text('Name', 30, startY);
          doc.text('Produkte', 70, startY);
          doc.text('Total (CHF)', 230, startY);
          doc.text('Datum', 260, startY);
          doc.setFont('helvetica', 'normal');
          startY += 10;
        }
      }
      doc.save('bestellungen.pdf');
    };
  </script>
</body>
</html>
